<body>
  <!-- ...todo el HTML de tus vistas, menús, modales, etc. aquí... -->

  <!-- El script debe ir al final del body -->
  <script>
    // ...todo el código JS de la app aquí, desde la declaración de variables hasta la inicialización...
    // (Pega aquí el JS que estaba fuera del <script> y elimina cualquier cierre de </div> o etiquetas mal ubicadas)
  </script>
</body>
        tdA.innerHTML=`<button class="${r.inc>0?"hist-view-inc":"hist-report-inc"}" data-id="${r.id}">${r.inc>0?"Ver":"Reportar"} incidencia</button> <button class="delete-paq" data-id="${r.id}">Eliminar</button>`;
        tr.appendChild(tdA);
        scanTbody.appendChild(tr);
      });

      // Controles de selección múltiple
      let controls = document.getElementById("multiPaqControls");
      if(!controls){
        controls = document.createElement("div");
        controls.id = "multiPaqControls";
        controls.style = "margin-bottom:8px;";
        scanTbody.parentElement.parentElement.insertBefore(controls, scanTbody.parentElement);
      }
      controls.innerHTML = `<button id='selectAllPaq'>${selectedPaquetes.size===filtered.length&&filtered.length>0?"Deseleccionar todos":"Seleccionar todos"}</button> <button id='deleteSelectedPaq'>Eliminar seleccionados</button> <span id='paqSelCount'></span>`;
      document.getElementById("selectAllPaq").onclick = ()=>{
        if(selectedPaquetes.size===filtered.length&&filtered.length>0){
          filtered.forEach(r=>selectedPaquetes.delete(r.id));
        }else{
          filtered.forEach(r=>selectedPaquetes.add(r.id));
        }
        renderTable();
      };
      document.getElementById("selectAllPaqChk").checked = selectedPaquetes.size===filtered.length&&filtered.length>0;
      document.getElementById("selectAllPaqChk").onclick = ()=>{
        document.getElementById("selectAllPaq").click();
      };
      document.getElementById("deleteSelectedPaq").onclick = async ()=>{
        if(selectedPaquetes.size===0) return showToast("No hay paquetes seleccionados","error");
        if(!confirm(`¿Eliminar ${selectedPaquetes.size} paquetes?`)) return;
        const password = prompt("Introduce la contraseña para eliminar los paquetes:");
        if(!password) return;
        let ok=0, fail=0;
        for(const id of selectedPaquetes){
          try{
            const res = await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/paquetes/${id}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password })
            });
            if(res.ok) ok++; else fail++;
          }catch{ fail++; }
        }
        showToast(`Eliminados: ${ok}, Fallidos: ${fail}`,(fail===0?"success":"error"));
        selectedPaquetes.clear();
        loadPage(currentPage);
      };
      document.getElementById("paqSelCount").innerText = selectedPaquetes.size>0?`${selectedPaquetes.size} seleccionados`:'';

      // Checkbox listeners
      scanTbody.querySelectorAll(".sel-paq").forEach(cb=>{
        cb.addEventListener("change",e=>{
          if(e.target.checked) selectedPaquetes.add(e.target.dataset.id);
          else selectedPaquetes.delete(e.target.dataset.id);
          document.getElementById("paqSelCount").innerText = selectedPaquetes.size>0?`${selectedPaquetes.size} seleccionados`:'';
          document.getElementById("selectAllPaqChk").checked = selectedPaquetes.size===filtered.length&&filtered.length>0;
        });
      });

      const totalPages=Math.max(1,Math.ceil(totalItems/pageSize));
      pageInfo.innerText=`Página ${currentPage} de ${totalPages}`;
      prevPageBtn.disabled=currentPage===1;
      nextPageBtn.disabled=currentPage===totalPages;
    }

    // --- Selección múltiple de incidencias ---
    function renderIncTable(){
      const all=filteredInc().sort((a,b)=>{
        const av=a[incSortCol], bv=b[incSortCol];
        if(av<bv) return incSortAsc?-1:1;
        if(av>bv) return incSortAsc?1:-1;
        return 0;
      });
      const start=(incPage-1)*incPageSize+1;
      const end=Math.min(incPage*incPageSize, all.length);
      incPageInfoEl.innerText=`Mostrando ${start}–${end} de ${all.length} incidencias`;

      // Encabezado con checkbox
      incTbody.parentElement.querySelector("thead")?.remove();
      const thead = document.createElement("thead");
      thead.innerHTML = `<tr>
        <th style='width:32px;'><input type='checkbox' id='selectAllIncChk'></th>
        <th data-col='_id'>ID</th>
        <th data-col='paquete_id'>Paquete</th>
        <th data-col='tipo'>Tipo</th>
        <th data-col='estado'>Estado</th>
        <th data-col='fecha_creacion'>Fecha creación</th>
        <th>Acciones</th>
      </tr>`;
      incTbody.parentElement.insertBefore(thead, incTbody);

      incTbody.innerHTML="";
      all.slice(start-1,end).forEach(i=>{
        const tr=document.createElement("tr");
        // Checkbox de selección
        const tdSel=document.createElement("td");
        tdSel.style='text-align:center;';
        tdSel.innerHTML = `<input type='checkbox' class='sel-inc' data-id='${i._id}' ${selectedIncidencias.has(i._id)?'checked':''}>`;
        tr.appendChild(tdSel);
        ["_id","paquete_id","tipo"].forEach(k=>{
        const tdA=document.createElement("td");
        tdA.innerHTML = `<button class="hist-view-inc" data-id="${r.id}">Ver incidencia</button> <button class="delete-paq" data-id="${r.id}">Eliminar</button>`;
        tr.appendChild(tdA);
        scanTbody.appendChild(tr);
        tdEst.innerHTML=`<span style="color:${i.estado==="Abierta"?"red":i.estado==="En proceso"?"orange":"green"}">${i.estado}</span>`;
        tr.appendChild(tdEst);
        const tdDate=document.createElement("td");
        tdDate.innerText=formatDateTime(i.fecha_creacion);
        tr.appendChild(tdDate);
        const tdA=document.createElement("td");
        tdA.innerHTML=`<button class="view-inc" data-id="${i._id}">Ver</button> <button class="edit-inc" data-id="${i._id}">Editar</button> <button class="delete-inc" data-id="${i._id}">Eliminar</button>`;
        tr.appendChild(tdA);
        incTbody.appendChild(tr);

        // Eliminar cualquier renderizado duplicado de comentarios aquí (los comentarios solo deben mostrarse en el modal de detalle, no en la tabla)
      });

      // Controles de selección múltiple
      let controls = document.getElementById("multiIncControls");
      if(!controls){
        controls = document.createElement("div");
        controls.id = "multiIncControls";
        controls.style = "margin-bottom:8px;";
        incTbody.parentElement.parentElement.insertBefore(controls, incTbody.parentElement);
      }
      controls.innerHTML = `<button id='selectAllInc'>${selectedIncidencias.size===all.length&&all.length>0?"Deseleccionar todos":"Seleccionar todos"}</button> <button id='deleteSelectedInc'>Eliminar seleccionados</button> <span id='incSelCount'></span>`;
      document.getElementById("selectAllInc").onclick = ()=>{
        if(selectedIncidencias.size===all.length&&all.length>0){
          all.forEach(i=>selectedIncidencias.delete(i._id));
        }else{
          all.forEach(i=>selectedIncidencias.add(i._id));
        }
        renderIncTable();
      };
      document.getElementById("selectAllIncChk").checked = selectedIncidencias.size===all.length&&all.length>0;
      document.getElementById("selectAllIncChk").onclick = ()=>{
        document.getElementById("selectAllInc").click();
      };
      document.getElementById("deleteSelectedInc").onclick = async ()=>{
        if(selectedIncidencias.size===0) return showToast("No hay incidencias seleccionadas","error");
        if(!confirm(`¿Eliminar ${selectedIncidencias.size} incidencias?`)) return;
        const password = prompt("Introduce la contraseña para eliminar las incidencias:");
        if(!password) return;
        let ok=0, fail=0;
        for(const id of selectedIncidencias){
          try{
            const res = await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/incidencias/${id}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password })
            });
            if(res.ok) ok++; else fail++;
          }catch{ fail++; }
        }
        showToast(`Eliminadas: ${ok}, Fallidas: ${fail}`,(fail===0?"success":"error"));
        selectedIncidencias.clear();
        loadIncidencias();
      };
      document.getElementById("incSelCount").innerText = selectedIncidencias.size>0?`${selectedIncidencias.size} seleccionadas`:'';

      // Checkbox listeners
      incTbody.querySelectorAll(".sel-inc").forEach(cb=>{
        cb.addEventListener("change",e=>{
          if(e.target.checked) selectedIncidencias.add(e.target.dataset.id);
          else selectedIncidencias.delete(e.target.dataset.id);
          document.getElementById("incSelCount").innerText = selectedIncidencias.size>0?`${selectedIncidencias.size} seleccionadas`:'';
          document.getElementById("selectAllIncChk").checked = selectedIncidencias.size===all.length&&all.length>0;
        });
      });

      const maxP=Math.max(1, Math.ceil(filteredInc().length/incPageSize));
      incPrevBtn.disabled=incPage===1;
      incNextBtn.disabled=incPage===maxP;
    }

    // Manejo de eliminación de paquete
    scanTbody.addEventListener("click", async e=>{
      if(e.target.matches(".delete-paq")){
        const id = e.target.dataset.id;
        const password = prompt("Introduce la contraseña para eliminar el paquete:");
        if(!password) return;
        try{
          const res = await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/paquetes/${id}`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password })
          });
          const j = await res.json();
          if(res.ok){
            showToast("Paquete eliminado correctamente","success");
            loadPage(currentPage);
          }else{
            showToast(j.error||"Error al eliminar paquete","error");
          }
        }catch{
          showToast("Error de red","error");
        }
      }
    });

    // — Orden y filtro —
    document.querySelectorAll("#scanTable th[data-col]").forEach(th=>{
      th.addEventListener("click", ()=>{
        const c=th.dataset.col;
        if(sortField===c) sortOrder=sortOrder==="asc"?"desc":"asc";
        else{ sortField=c; sortOrder="asc"; }
        loadPage(1);
      });
    });
    stateFilter.addEventListener("change", e=>{
      filterState=e.target.value;
      loadPage(1);
    });
    searchInput.addEventListener("input", e=>{
      filterText=e.target.value.toLowerCase();
      renderTable();
    });
    prevPageBtn.addEventListener("click", ()=>{ if(currentPage>1) loadPage(currentPage-1); });
    nextPageBtn.addEventListener("click", ()=>{ const tp=Math.ceil(totalItems/pageSize); if(currentPage<tp) loadPage(currentPage+1); });

    // — Incidencias y modal de reporte —
    function attachRowClicks(sel){
      document.querySelector(sel).addEventListener("click", e=>{
        const id=e.target.dataset.id;
        if(!id) return;
        if(e.target.matches(".inc-count")||
           e.target.matches(".mini-view-inc")||
           e.target.matches(".hist-view-inc")){
          showView("view-incidencias");
          document.getElementById("incSearch").value=id;
          incFilterText=id.toLowerCase();
          loadIncidencias();
        } else if(e.target.matches(".mini-report-inc")||
                  e.target.matches(".hist-report-inc")){
          incPaquete.value=id;
          modal.style.display="flex";
        }
      });
    }
    attachRowClicks("#miniTable");
    attachRowClicks("#scanTable");

    // Limpiar formulario de incidencia
    function clearIncForm() {
      incPaquete.value = "";
      incTipo.value = "";
      incDesc.value = "";
      incAdjuntos.value = "";
      // Limpiar lista visual de archivos preadjuntos si existe
      const preList = document.getElementById("incAdjuntosList");
      if (preList) preList.innerHTML = "";
    }

    // Mostrar lista de archivos preadjuntos con opción de eliminar
    if (!document.getElementById("incAdjuntosList")) {
      const list = document.createElement("div");
      list.id = "incAdjuntosList";
      incAdjuntos.parentElement.insertBefore(list, incAdjuntos.nextSibling);
    }
    incAdjuntos.addEventListener("change", function() {
      const list = document.getElementById("incAdjuntosList");
      list.innerHTML = "";
      Array.from(incAdjuntos.files).forEach((f, idx) => {
        const fileDiv = document.createElement("div");
        fileDiv.style = "display:flex;align-items:center;gap:4px;";
        fileDiv.innerHTML = `<span>${f.name}</span> <button type='button' class='del-pre-file' data-idx='${idx}' style='color:red;font-weight:bold;'>×</button>`;
        list.appendChild(fileDiv);
      });
    });
    document.getElementById("incAdjuntosList").addEventListener("click", function(e) {
      if (e.target.classList.contains("del-pre-file")) {
        const idx = parseInt(e.target.dataset.idx);
        const dt = new DataTransfer();
        Array.from(incAdjuntos.files).forEach((f, i) => { if (i !== idx) dt.items.add(f); });
        incAdjuntos.files = dt.files;
        incAdjuntos.dispatchEvent(new Event("change"));
      }
    });

    incCancel.addEventListener("click", ()=>{ modal.style.display="none"; clearIncForm(); });
    incSave.addEventListener("click", async ()=>{
      const form=new FormData();
      form.append("paquete_id", incPaquete.value);
      form.append("tipo", incTipo.value);
      form.append("descripcion", incDesc.value);
      Array.from(incAdjuntos.files).forEach(f=> form.append("adjuntos", f));
      try{
        const res=await fetch("https://servidor-backend-paquetes.onrender.com/scanner/incidencias", {
          method:"POST", body:form
        });
        const j=await res.json();
        if(res.ok){
          showToast("Incidencia creada correctamente","success");
          modal.style.display="none";
          clearIncForm();
          loadPage(currentPage);
        } else {
          showToast(j.error||"Error al crear incidencia","error");
        }
      } catch{
        showToast("Error de red","error");
      }
    });

    const incTbody      = document.querySelector("#incTable tbody");
    const incPrevBtn    = document.getElementById("incPrev");
    const incNextBtn    = document.getElementById("incNext");
    const incPageInfoEl = document.getElementById("incPageInfo");

    document.getElementById("incSearch")
      .addEventListener("input", e=>{
        incFilterText=e.target.value.toLowerCase();
        incPage=1;
        renderIncTable();
      });
    document.getElementById("incTipoFilter")
      .addEventListener("change", e=>{
        incFilterTipo=e.target.value;
        incPage=1;
        renderIncTable();
      });
    document.getElementById("incEstadoFilter")
      .addEventListener("change", e=>{
        incFilterEstado=e.target.value;
        incPage=1;
        renderIncTable();
      });

    async function loadIncidencias(){
      try{
        const r=await fetch("https://servidor-backend-paquetes.onrender.com/scanner/incidencias");
        incData=await r.json();
        incPage=1;
        renderIncTable();
      } catch(e){
        console.error("Error cargando incidencias:", e);
      }
    }

    function filteredInc(){
      return incData.filter(i=>
        (!incFilterText   || i._id.includes(incFilterText)   || i.paquete_id.toLowerCase().includes(incFilterText)) &&
        (!incFilterTipo   || i.tipo===incFilterTipo) &&
        (!incFilterEstado || i.estado===incFilterEstado)
      );
    }

    function renderIncTable(){
      const all=filteredInc().sort((a,b)=>{
        const av=a[incSortCol], bv=b[incSortCol];
        if(av<bv) return incSortAsc?-1:1;
        if(av>bv) return incSortAsc?1:-1;
        return 0;
      });
      const start=(incPage-1)*incPageSize+1;
      const end=Math.min(incPage*incPageSize, all.length);
      incPageInfoEl.innerText=`Mostrando ${start}–${end} de ${all.length} incidencias`;

      // Encabezado con checkbox
      incTbody.parentElement.querySelector("thead")?.remove();
      const thead = document.createElement("thead");
      thead.innerHTML = `<tr>
        <th style='width:32px;'><input type='checkbox' id='selectAllIncChk'></th>
        <th data-col='_id'>ID</th>
        <th data-col='paquete_id'>Paquete</th>
        <th data-col='tipo'>Tipo</th>
        <th data-col='estado'>Estado</th>
        <th data-col='fecha_creacion'>Fecha creación</th>
        <th>Acciones</th>
      </tr>`;
      incTbody.parentElement.insertBefore(thead, incTbody);

      incTbody.innerHTML="";
      all.slice(start-1,end).forEach(i=>{
        const tr=document.createElement("tr");
        // Checkbox de selección
        const tdSel=document.createElement("td");
        tdSel.style='text-align:center;';
        tdSel.innerHTML = `<input type='checkbox' class='sel-inc' data-id='${i._id}' ${selectedIncidencias.has(i._id)?'checked':''}>`;
        tr.appendChild(tdSel);
        ["_id","paquete_id","tipo"].forEach(k=>{
          const td=document.createElement("td");
          td.innerText=i[k]; tr.appendChild(td);
        });
        const tdEst=document.createElement("td");
        tdEst.innerText = i.estado;
        tr.appendChild(tdEst);

        const tdDate=document.createElement("td");
        tdDate.innerText=formatDateTime(i.fecha_creacion);
        tr.appendChild(tdDate);

        const tdA=document.createElement("td");
        tdA.innerHTML = `<button class="view-inc" data-id="${i._id}">Ver</button> <button class="edit-inc" data-id="${i._id}">Editar</button> <button class="delete-inc" data-id="${i._id}">Eliminar</button>`;
        tr.appendChild(tdA);
        incTbody.appendChild(tr);
      });

      const maxP=Math.max(1, Math.ceil(filteredInc().length/incPageSize));
      incPrevBtn.disabled=incPage===1;
      incNextBtn.disabled=incPage===maxP;
    }

    // Manejo de eliminación de incidencia
    incTbody.addEventListener("click", async e=>{
      if(e.target.matches(".delete-inc")){
        const id = e.target.dataset.id;
        const password = prompt("Introduce la contraseña para eliminar la incidencia:");
        if(!password) return;
        try{
          const res = await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/incidencias/${id}`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password })
          });
          const j = await res.json();
          if(res.ok){
            showToast("Incidencia eliminada correctamente","success");
            loadIncidencias();
          }else{
            showToast(j.error||"Error al eliminar incidencia","error");
          }
        }catch{
          showToast("Error de red","error");
        }
      }
    });

    // — Abrir modal de detalle/incidencia —
    document.getElementById("view-incidencias").addEventListener("click", async e=>{
      if(e.target.matches(".view-inc") || e.target.matches(".edit-inc")){
        currentIncId=e.target.dataset.id;
        // resetear campos no guardados
        detailCommentInput.value="";
        detailFileInput.value="";
        try{
          const res=await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/incidencias/${currentIncId}`);
          const inc=await res.json();
          detailStateSelect.value=inc.estado;
          detailAttachments.innerHTML = "";
          if (inc.adjuntos && inc.adjuntos.length > 0) {
            inc.adjuntos.forEach(adj => {
              let url = adj.url || adj;
              let nombre = adj.nombre || "Adjunto";
              const ext = url.split('.').pop().toLowerCase();
              if (["jpg","jpeg","png","gif","bmp","webp"].includes(ext)) {
                const img = document.createElement("img");
                img.src = url;
                img.onclick = () => window.open(url, "_blank");
                img.title = nombre;
                detailAttachments.appendChild(img);
              } else {
                const link = document.createElement("a");
                link.href = url;
                link.target = "_blank";
                link.innerText = nombre;
                link.style.margin = "4px";
                detailAttachments.appendChild(link);
              }
            });
          } else {
            detailAttachments.innerHTML = '<span style="color:#888;">Sin adjuntos</span>';
          }
          // Mostrar comentarios (filtrar historial por eventos con comentario y sin estado ni adjuntos)
          const comments = (inc.historial||[]).filter(ev => ev.comentario && !ev.estado && (!ev.adjuntos || ev.adjuntos.length===0));
          const detailComments = document.getElementById("detailComments");
          if (comments.length > 0) {
            detailComments.innerHTML = comments.map(ev =>
              `<div style='margin-bottom:8px;'><span style='color:#333;'>${ev.comentario}</span><br><span style='font-size:0.8em;color:#888;'>${formatDateTime(ev.fecha)}</span></div>`
            ).join("");
          } else {
            detailComments.innerHTML = '<span style="color:#888;">Sin comentarios</span>';
          }
          renderDetailTimeline(inc.historial);
          detailModal.style.display = "flex";
        } catch{
          showToast("No se pudo cargar la incidencia","error");
        }
      }
    });

    // — Guardar todos los cambios (estado, comentario, adjuntos) en un solo botón —
    detailSaveBtn.addEventListener("click", async ()=>{
      detailSaveBtn.disabled=true;
      try{
        // actualizar estado y comentario
        await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/incidencias/${currentIncId}`, {
          method:"PUT",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({
            nuevo_estado: detailStateSelect.value,
            comentario: detailCommentInput.value
          })
        });
        // subir adjuntos si hay archivos seleccionados
        if(detailFileInput.files.length){
          const form=new FormData();
          Array.from(detailFileInput.files).forEach(f=>form.append("adjuntos",f));
          await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/incidencias/${currentIncId}`, {
            method:"POST",
            body: form
          });
        }
        showToast("Cambios guardados","success");
        detailModal.style.display="none";
        loadIncidencias();
      }catch(err){
        showToast(err.error||"Error al guardar cambios","error");
      }finally{
        detailSaveBtn.disabled=false;
      }
    });

    // — Cerrar modal sin guardar —
    detailCloseIcon.addEventListener("click", ()=>{
      detailModal.style.display="none";
    });

    function renderDetailTimeline(historial){
      historial.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
      detailTimeline.innerHTML = historial.map(ev => {
        let html = '';
        if (ev.estado) {
          html += `<div><strong>Estado:</strong> ${ev.estado} <span style="font-size:0.8em;color:#666;">${formatDateTime(ev.fecha)}</span></div>`;
        }
        if (ev.comentario) {
          html += `<div><strong>Comentario:</strong> ${ev.comentario} <span style="font-size:0.8em;color:#666;">${formatDateTime(ev.fecha)}</span></div>`;
        }
        if (ev.adjuntos && Array.isArray(ev.adjuntos) && ev.adjuntos.length > 0) {
          html += `<div><strong>Adjuntos:</strong> `;
          ev.adjuntos.forEach(adj => {
            let url = adj.url || adj;
            let nombre = adj.nombre || "Adjunto";
            const ext = url.split('.').pop().toLowerCase();
            if (["jpg","jpeg","png","gif","bmp","webp"].includes(ext)) {
              html += `<img src="${url}" style="width:50px;vertical-align:middle;margin:2px;cursor:pointer;" onclick="window.open('${url}','_blank')" title="${nombre}" />`;
            } else {
              html += `<a href="${url}" target="_blank" style="margin:2px;">${nombre}</a>`;
            }
          });
          html += ` <span style=\"font-size:0.8em;color:#666;\">${formatDateTime(ev.fecha)}</span></div>`;
        }
        return html;
      }).join("");
    }

    // — Inicialización —
    loadPage(1);
    showView("view-escaneo");
  </script>
</body>
</html>

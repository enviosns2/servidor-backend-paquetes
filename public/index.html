<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escáner de Código de Barras</title>
  <style>
    #status {
      margin-top: 10px;
      font-size: 1rem;
    }
    .success {
      color: green;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <h1>Escáner de Código de Barras</h1>
  <p id="mode">Modo actual: <strong>Recibido</strong></p>
  <button onclick="toggleMode()">Cambiar Modo</button>
  <!-- Menú desplegable oculto hasta pulsar el botón -->
  <select id="modeSelect" style="display:none;">
    <option value="recibido">Recibido</option>
    <option value="en-transito-nacional-mx">En tránsito nacional MX</option>
    <option value="en-transito-nacional-eu">En tránsito nacional EU</option>
    <option value="en-transito-internacional">En tránsito internacional</option>
    <option value="en-almacen-eu">En almacén EU</option>
    <option value="en-almacen-mx">En almacén MX</option>
  </select>

  <input type="text" id="barcodeInput" placeholder="Escanea el código aquí" autofocus />

  <p id="status" aria-live="polite"></p>

  <script>
    console.log("Script cargado correctamente");

    let mode = "recibido"; // Modo inicial

    function toggleMode() {
      const sel = document.getElementById("modeSelect");
      sel.style.display = sel.style.display === "none" ? "inline-block" : "none";
    }

    document.getElementById("modeSelect").addEventListener("change", function() {
      mode = this.value;
      const label = this.options[this.selectedIndex].text;
      document.getElementById("mode").innerHTML = `Modo actual: <strong>${label}</strong>`;
      clearStatus();
      this.style.display = "none";
    });

    function clearStatus() {
      const status = document.getElementById("status");
      status.innerText = "";
      status.className = "";
    }

    function sanitizeInput(value) {
      console.log("sanitizeInput - Valor original:", value);
      const sanitized = value.replace(/[^0-9a-zA-Z]/g, "-");
      console.log("sanitizeInput - Valor sanitizado:", sanitized);
      return sanitized;
    }

    const barcodeInput = document.getElementById("barcodeInput");

    barcodeInput.addEventListener("beforeinput", function () {
      this.value = sanitizeInput(this.value);
    });
    barcodeInput.addEventListener("input", function () {
      this.value = sanitizeInput(this.value);
    });
    barcodeInput.addEventListener("paste", function () {
      setTimeout(() => {
        this.value = sanitizeInput(this.value);
      }, 50);
    });
    barcodeInput.addEventListener("keyup", function () {
      this.value = sanitizeInput(this.value);
    });
    setInterval(() => {
      let cv = barcodeInput.value;
      let sv = sanitizeInput(cv);
      if (cv !== sv) barcodeInput.value = sv;
    }, 25);
    new MutationObserver(() => {
      let nv = sanitizeInput(barcodeInput.value);
      if (barcodeInput.value !== nv) barcodeInput.value = nv;
    }).observe(barcodeInput, { childList: true, characterData: true, subtree: true });

    async function sendBarcode(barcode) {
      if (!barcode) {
        updateStatus("Por favor, escanea un código válido.", "error");
        return;
      }
      const sanitizedBarcode = sanitizeInput(barcode);
      const endpoint = mode === "recibido"
          ? "https://servidor-backend-paquetes.onrender.com/scanner/recibido"
          : `https://servidor-backend-paquetes.onrender.com/scanner/${mode}`;

      barcodeInput.disabled = true;
      try {
        const resp = await fetch(endpoint, {
          method: mode === "recibido" ? "POST" : "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paquete_id: sanitizedBarcode })
        });
        const json = await resp.json();
        if (resp.ok) updateStatus(json.message || "Operación realizada correctamente.", "success");
        else       updateStatus(json.error   || "Ocurrió un error.",          "error");
      } catch (e) {
        console.error("Error al enviar los datos:", e);
        updateStatus("Error al conectar con el servidor.", "error");
      } finally {
        barcodeInput.value = "";
        barcodeInput.disabled = false;
        barcodeInput.focus();
      }
    }

    function updateStatus(msg, cls) {
      const s = document.getElementById("status");
      s.innerText = msg;
      s.className = cls;
      setTimeout(clearStatus, 5000);
    }

    barcodeInput.addEventListener("keydown", function (evt) {
      if (evt.key === "Enter") {
        evt.preventDefault();
        setTimeout(() => {
          const code = sanitizeInput(this.value.trim());
          sendBarcode(code);
        }, 150);
      }
    });
  </script>
</body>
</html>

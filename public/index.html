<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scanner de rastreo</title>
  <style>
    /* Layout */
    body {
      margin: 0; font-family: sans-serif;
      display: flex; flex-direction: column; height: 100vh;
    }
    header {
      position: fixed; top: 0; left: 0; right: 0;
      height: 60px; background: #333; color: #fff;
      display: flex; align-items: center; padding: 0 20px;
      z-index: 1000;
    }
    header .logo img {
      height: 40px; margin-right: 20px;
    }
    header h1 {
      margin: 0; font-size: 1.2rem;
    }
    #container {
      display: flex; flex: 1; padding-top: 60px;
    }
    aside {
      width: 20%; background: #f4f4f4;
      padding: 20px; box-sizing: border-box;
    }
    aside nav a {
      display: flex; align-items: center;
      padding: 8px 0; color: #333; text-decoration: none;
    }
    aside nav a .icon {
      margin-right: 8px;
    }
    main {
      flex: 1; padding: 20px;
      box-sizing: border-box; overflow-y: auto;
    }

    /* Scanner widget */
    #scannerWidget {
      background: #fafafa; padding: 15px;
      border: 1px solid #ddd; margin-bottom: 20px;
    }
    #scannerWidget label,
    #scannerWidget select,
    #scannerWidget input {
      display: block; width: 100%; margin-bottom: 10px;
    }
    #status {
      margin-top: 10px; font-size: 0.95rem;
    }
    .success { color: green; }
    .error   { color: red; }

    /* Mini-historial */
    #miniHistory {
      margin-bottom: 30px;
    }
    #miniHistory h2 {
      margin: 0 0 10px;
    }
    #miniTable {
      width: 100%; border-collapse: collapse;
    }
    #miniTable th, #miniTable td {
      border: 1px solid #ccc; padding: 6px; text-align: left;
    }
    #miniTable th {
      background: #eee;
    }
    .highlight {
      animation: highlight 1s ease;
    }
    @keyframes highlight {
      from { background: yellow; }
      to   { background: transparent; }
    }

    /* Toast */
    #toast {
      position: fixed; top: 70px; right: 20px;
      padding: 10px 15px; background: #333; color: #fff;
      border-radius: 4px; opacity: 0; transition: opacity 0.3s;
      z-index: 1001;
    }
    #toast.show { opacity: 1; }
    #toast.success { background: green; }
    #toast.error   { background: red; }

    /* Tables */
    #tableControls,
    #incTableControls {
      margin-bottom: 10px;
      display: flex; align-items: center; gap: 10px;
    }
    #counter {
      margin-bottom: 8px; font-weight: bold;
    }
    table {
      width: 100%; border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc; padding: 8px; text-align: left;
    }
    th {
      cursor: pointer; background: #eee;
    }
    #pagination, #incPagination {
      margin-top: 10px; display: flex;
      align-items: center; gap: 10px;
    }
    #pagination button:disabled,
    #incPagination button:disabled {
      opacity: 0.5; cursor: default;
    }

    /* Modal */
    .modal {
      display: none; position: fixed;
      top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5);
      align-items: center; justify-content: center;
      z-index: 1002;
    }
    .modal-content {
      position: relative;
      background:#fff; padding:20px;
      border-radius:4px; width:400px; max-width:90%;
    }
    .modal-content h2 { margin-top:0; }
    .modal-content label {
      margin:10px 0 4px; display:block;
    }
    .modal-content input[type="text"],
    .modal-content select,
    .modal-content textarea {
      width:100%; box-sizing:border-box;
    }
    .modal-content textarea {
      resize:vertical; min-height:60px;
    }
    .modal-content .buttons {
      margin-top:15px; text-align:right; gap:10px;
    }
    .close-icon {
      position: absolute; top: 10px; right: 15px;
      font-size: 1.5rem; cursor: pointer;
    }
    #detailAttachments img {
      width: 60px; margin: 4px; cursor: pointer;
    }
    #detailTimeline div {
      margin-bottom: 8px;
    }

    /* Dark mode styles */
    body.dark-mode {
      background: #181a1b;
      color: #e0e0e0;
    }
    body.dark-mode header {
      background: #23272b;
      color: #fff;
    }
    body.dark-mode aside {
      background: #202328;
      color: #e0e0e0;
    }
    body.dark-mode aside nav a {
      color: #b0b8c1;
    }
    body.dark-mode aside nav a:hover,
    body.dark-mode aside nav a:focus {
      color: #fff;
      background: #23272b;
    }
    body.dark-mode main {
      background: #181a1b;
      color: #e0e0e0;
    }
    body.dark-mode #scannerWidget,
    body.dark-mode #miniHistory,
    body.dark-mode #tableControls,
    body.dark-mode #incTableControls,
    body.dark-mode #counter,
    body.dark-mode #toast,
    body.dark-mode .modal-content {
      background: #23272b !important;
      color: #e0e0e0 !important;
      border-color: #444 !important;
    }
    body.dark-mode #miniTable,
    body.dark-mode #scanTable,
    body.dark-mode #incTable {
      background: #23272b;
      color: #e0e0e0;
    }
    body.dark-mode th, body.dark-mode #miniTable th, body.dark-mode #scanTable th, body.dark-mode #incTable th {
      background: #23272b !important;
      color: #f0f0f0 !important;
      border-color: #444 !important;
    }
    body.dark-mode td, body.dark-mode #miniTable td, body.dark-mode #scanTable td, body.dark-mode #incTable td {
      background: #23272b !important;
      color: #e0e0e0 !important;
      border-color: #444 !important;
    }
    body.dark-mode tr:nth-child(even) td {
      background: #202328 !important;
    }
    body.dark-mode #pagination,
    body.dark-mode #incPagination {
      background: transparent;
      color: #e0e0e0;
    }
    body.dark-mode #toast.success { background: #357a38 !important; color: #fff !important; }
    body.dark-mode #toast.error   { background: #b71c1c !important; color: #fff !important; }
    body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
      background: #23272b;
      color: #e0e0e0;
      border: 1px solid #444;
    }
    body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode textarea:focus {
      outline: 2px solid #4f8cff;
      background: #23272b;
      color: #fff;
    }
    body.dark-mode #detailAttachments img {
      border: 1px solid #444;
    }
    body.dark-mode a, body.dark-mode a:visited {
      color: #4f8cff;
    }
    body.dark-mode a:hover {
      color: #82aaff;
    }
    body.dark-mode .success { color: #7fff7f !important; }
    body.dark-mode .error   { color: #ff7f7f !important; }
    body.dark-mode .highlight {
      animation: highlight-dark 1s ease;
    }
    @keyframes highlight-dark {
      from { background: #444444; }
      to   { background: transparent; }
    }
    /* Switch visual para alternar tema */
    .theme-switch {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      margin-top: 16px;
    }
    .theme-switch input[type="checkbox"] {
      display: none;
    }
    .theme-switch .slider {
      width: 44px;
      height: 24px;
      background: #ccc;
      border-radius: 24px;
      position: relative;
      transition: background 0.3s;
      margin-right: 10px;
    }
    .theme-switch .slider::before {
      content: "";
      position: absolute;
      left: 3px;
      top: 3px;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.3s, background 0.3s;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
    .theme-switch input[type="checkbox"]:checked + .slider {
      background: #23272b;
    }
    .theme-switch input[type="checkbox"]:checked + .slider::before {
      transform: translateX(20px);
      background: #4f8cff;
    }
    .theme-switch .label-text {
      font-size: 1rem;
      color: inherit;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="./LOGO.png" alt="Logo Empresa">
    </div>
    <h1>Scanner de rastreo</h1>
  </header>

  <div id="container">
    <aside>
      <nav>
        <a href="#" id="nav-escaneo"><span class="icon">üîç</span>Escaneo</a>
        <a href="#" id="nav-historial"><span class="icon">üìú</span>Historial</a>
        <a href="#" id="nav-incidencias"><span class="icon">‚ö†Ô∏è</span>Incidencias</a>
        <a href="#" id="nav-reportes"><span class="icon">üìä</span>Reportes</a>
        <a href="#" id="nav-ajustes"><span class="icon">‚öôÔ∏è</span>Ajustes</a>
      </nav>
    </aside>

    <main>
      <!-- ESCANEO -->
      <section id="view-escaneo">
        <div id="scannerWidget">
          <p id="mode">Modo actual: <strong>Recibido</strong></p>
          <label for="modeSelect">Selecciona fase:</label>
          <select id="modeSelect">
            <optgroup label="Recepci√≥n">
              <option value="recibido">Recibido</option>
            </optgroup>
            <optgroup label="Tr√°nsito">
              <option value="en-transito-nacional-mx">En tr√°nsito nacional MX</option>
              <option value="en-transito-nacional-eu">En tr√°nsito nacional EU</option>
              <option value="en-transito-internacional">En tr√°nsito internacional</option>
            </optgroup>
            <optgroup label="Almac√©n">
              <option value="en-almacen-eu">En almac√©n EU</option>
              <option value="en-almacen-mx">En almac√©n MX</option>
            </optgroup>
          </select>
          <label for="barcodeInput">Escanea o pega el c√≥digo:</label>
          <input type="text" id="barcodeInput" placeholder="Escanea el c√≥digo aqu√≠" autofocus>
          <p id="status" aria-live="polite"></p>
        </div>

        <!-- MINI-HISTORIAL -->
        <div id="miniHistory">
          <h2>√öltimos escaneos</h2>
          <table id="miniTable">
            <thead>
              <tr>
                <th>Fecha y hora</th>
                <th>Paquete</th>
                <th>Estado nuevo</th>
                <th>Estado anterior</th>
                <th>Incidencias</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- HISTORIAL COMPLETO -->
      <section id="view-historial" style="display:none;">
        <div id="counter">Mostrando 0 de 0 paquetes</div>
        <div id="tableControls">
          <input type="text" id="searchInput" placeholder="Buscar paquete‚Ä¶">
          <select id="stateFilter">
            <option value="">Todos los estados</option>
            <optgroup label="Recepci√≥n"><option value="Recibido">Recibido</option></optgroup>
            <optgroup label="Tr√°nsito">
              <option value="En tr√°nsito nacional MX">En tr√°nsito nacional MX</option>
              <option value="En tr√°nsito nacional EU">En tr√°nsito nacional EU</option>
              <option value="En tr√°nsito internacional">En tr√°nsito internacional</option>
            </optgroup>
            <optgroup label="Almac√©n">
              <option value="En almac√©n EU">En almac√©n EU</option>
              <option value="En almac√©n MX">En almac√©n MX</option>
            </optgroup>
          </select>
        </div>
        <table id="scanTable">
          <thead>
            <tr>
              <th data-col="time">Fecha y hora</th>
              <th data-col="id">Paquete</th>
              <th data-col="new">Estado nuevo</th>
              <th data-col="prev">Estado anterior</th>
              <th data-col="inc">Incidencias</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="pagination">
          <button id="prevPage">Anterior</button>
          <span id="pageInfo">P√°gina 1</span>
          <button id="nextPage">Siguiente</button>
        </div>
      </section>

      <!-- INCIDENCIAS -->
      <section id="view-incidencias" style="display:none;">
        <div id="incTableControls">
          <input type="text" id="incSearch" placeholder="Buscar ID o paquete‚Ä¶">
          <select id="incTipoFilter">
            <option value="">Todos los tipos</option>
            <option value="Da√±ado">Da√±ado</option>
            <option value="Falta docs">Falta docs</option>
            <option value="Direcci√≥n incorrecta">Direcci√≥n incorrecta</option>
            <option value="Cliente ausente">Cliente ausente</option>
            <option value="Otro">Otro</option>
          </select>
          <select id="incEstadoFilter">
            <option value="">Todos los estados</option>
            <option value="Abierta">Abierta</option>
            <option value="En proceso">En proceso</option>
            <option value="Resuelta">Resuelta</option>
            <option value="Cerrada">Cerrada</option>
            <option value="Rechazada">Rechazada</option>
          </select>
        </div>
        <table id="incTable">
          <thead>
            <tr>
              <th data-col="_id">ID</th>
              <th data-col="paquete_id">Paquete</th>
              <th data-col="tipo">Tipo</th>
              <th data-col="estado">Estado</th>
              <th data-col="fecha_creacion">Fecha creaci√≥n</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="incPagination">
          <button id="incPrev">Anterior</button>
          <span id="incPageInfo">P√°gina 1</span>
          <button id="incNext">Siguiente</button>
        </div>
      </section>

      <!-- REPORTES -->
      <section id="view-reportes" style="display:none;">
        <h2>Reportes</h2>
        <div id="contenedoresReportes" style="background:#f9f9f9; border:1px solid #ddd; padding:24px; border-radius:6px; min-height:180px;">
          <button id="btnCrearContenedor" style="margin-bottom:16px;">Crear contenedor</button>
          <p id="contenedoresLoading" style="color:#888;">Cargando contenedores...</p>
          <div id="contenedoresCards" style="display:flex;flex-wrap:wrap;gap:18px;margin-top:12px;"></div>
        </div>
      </section>

      <!-- AJUSTES -->
      <section id="view-ajustes" style="display:none;">
        <h2 id="settingsTitle">Ajustes</h2>
        <div style="background:#f9f9f9; border:1px solid #ddd; padding:24px; border-radius:6px; min-height:120px;">
          <p id="settingsDesc" style="color:#888;">Configuraci√≥n y preferencias del sistema.</p>
          <label class="theme-switch">
            <input type="checkbox" id="toggleThemeSwitch">
            <span class="slider"></span>
            <span class="label-text" id="themeLabel">Modo oscuro</span>
          </label>
          <div style="margin-top:18px;">
            <label for="langSelect" id="langLabel" style="margin-right:8px;">Idioma:</label>
            <select id="langSelect">
              <option value="es">Espa√±ol</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal para reportar incidencia -->
  <div id="incidenceModal" class="modal">
    <div class="modal-content">
      <h2>Reportar incidencia</h2>
      <label for="incPaquete">Paquete</label>
      <input type="text" id="incPaquete" readonly>
      <label for="incTipo">Tipo de incidencia</label>
      <select id="incTipo">
        <option value="">-- Seleccione --</option>
        <option value="Da√±ado">Da√±ado</option>
        <option value="Falta docs">Falta docs</option>
        <option value="Direcci√≥n incorrecta">Direcci√≥n incorrecta</option>
        <option value="Cliente ausente">Cliente ausente</option>
        <option value="Otro">Otro</option>
      </select>
      <label for="incDesc">Descripci√≥n</label>
      <textarea id="incDesc"></textarea>
      <label for="incAdjuntos">Adjuntar fotos/documentos</label>
      <input type="file" id="incAdjuntos" multiple>
      <div class="buttons">
        <button id="incCancel">Cancelar</button>
        <button id="incSave">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal para detalle y edici√≥n de incidencia -->
  <div id="incDetailModal" class="modal">
    <div class="modal-content">
      <span class="close-icon" id="detailCloseIcon">&times;</span>
      <h2>Detalle de Incidencia</h2>
      <div style="display: flex; gap: 16px; min-width: 340px; max-width: 700px;">
        <!-- Columna izquierda: Cambios/Historial -->
        <div style="flex:1; min-width: 180px; max-width: 320px; display: flex; flex-direction: column;">
          <label for="detailStateSelect">Estado</label>
          <select id="detailStateSelect">
            <option>Abierta</option>
            <option>En proceso</option>
            <option>Resuelta</option>
            <option>Cerrada</option>
            <option>Rechazada</option>
          </select>
          <label>Adjuntos existentes</label>
          <div id="detailAttachments" style="margin-bottom:8px;"></div>
          <label for="detailFileInput">Subir nuevos adjuntos</label>
          <input type="file" id="detailFileInput" multiple style="margin-bottom:8px; width: 140px;" />
          <style>
            /* Oculta el texto de nombre de archivo seleccionado en el input file del modal de detalle */
            #detailFileInput::-webkit-file-upload-button { margin-right: 0; }
            #detailFileInput { color: transparent; }
            #detailFileInput::file-selector-button { color: initial; }
          </style>
          <h3 style="margin-top:12px;">Historial de cambios</h3>
          <div id="detailTimeline" style="flex:1; min-height:120px; max-height:220px; overflow-y:auto; border:1px solid #eee; padding:4px; background:#fafbfc;"></div>
        </div>
        <!-- Columna derecha: Comentarios -->
        <div style="flex:1; min-width: 180px; max-width: 320px; border-left:1px solid #eee; padding-left:12px; display: flex; flex-direction: column;">
          <h3>Comentarios</h3>
          <div id="detailComments" style="flex:1; min-height:120px; max-height:220px; overflow-y:auto; margin-bottom:8px; background:#fafbfc; border:1px solid #eee; padding:4px;"></div>
          <label for="detailCommentInput">Nuevo comentario</label>
          <textarea id="detailCommentInput" style="resize:vertical; min-height:40px; max-height:80px;"></textarea>
        </div>
      </div>
      <div class="buttons">
        <button id="detailSaveBtn">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal para crear contenedor -->
  <div id="modalCrearContenedor" class="modal">
    <div class="modal-content">
      <h2 id="crearContenedorTitulo">Crear contenedor</h2>
      <label for="inputNombreContenedor" id="labelNombreContenedor">Nombre del contenedor</label>
      <input type="text" id="inputNombreContenedor" />
      <div class="buttons">
        <button id="btnCancelarCrearContenedor">Cancelar</button>
        <button id="btnGuardarCrearContenedor">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal para seleccionar contenedor destino -->
  <div id="modalAgregarContenedor" class="modal">
    <div class="modal-content">
      <h2 id="agregarContenedorTitulo">Agregar a contenedor</h2>
      <label for="selectContenedorDestino" id="labelContenedorDestino">Selecciona contenedor destino</label>
      <select id="selectContenedorDestino"></select>
      <div class="buttons">
        <button id="btnCancelarAgregarContenedor">Cancelar</button>
        <button id="btnGuardarAgregarContenedor">Agregar</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    console.log("Script cargado correctamente");

    // ‚Äî Variables globales ‚Äî
    let mode         = "recibido";
    let tableData    = [];
    let totalItems   = 0;
    let currentPage  = 1;
    let pageSize     = 10;
    let sortField    = "time";
    let sortOrder    = "desc";
    let filterText   = "";
    let filterState  = "";

    let incData      = [];
    let incSortCol   = "fecha_creacion";
    let incSortAsc   = false;
    let incFilterText= "";
    let incFilterTipo= "";
    let incFilterEstado= "";
    let incPage      = 1;
    let incPageSize  = 10;

    // --- Selecci√≥n m√∫ltiple de paquetes ---
    let selectedPaquetes = new Set();
    let selectedIncidencias = new Set();

    // ‚Äî Referencias DOM ‚Äî
    const counterEl    = document.getElementById("counter");
    const scanTbody    = document.querySelector("#scanTable tbody");
    const miniTbody    = document.querySelector("#miniTable tbody");
    const pageInfo     = document.getElementById("pageInfo");
    const prevPageBtn  = document.getElementById("prevPage");
    const nextPageBtn  = document.getElementById("nextPage");
    const searchInput  = document.getElementById("searchInput");
    const stateFilter  = document.getElementById("stateFilter");
    const toast        = document.getElementById("toast");
    const modal        = document.getElementById("incidenceModal");
    const incPaquete   = document.getElementById("incPaquete");
    const incTipo      = document.getElementById("incTipo");
    const incDesc      = document.getElementById("incDesc");
    const incAdjuntos  = document.getElementById("incAdjuntos");
    const incCancel    = document.getElementById("incCancel");
    const incSave      = document.getElementById("incSave");
    const modeSelect   = document.getElementById("modeSelect");
    const barcodeInput = document.getElementById("barcodeInput");
    const statusEl     = document.getElementById("status");

    // Referencias detalle incidencia
    const detailModal        = document.getElementById("incDetailModal");
    const detailCloseIcon    = document.getElementById("detailCloseIcon");
    const detailSaveBtn      = document.getElementById("detailSaveBtn");
    const detailStateSelect  = document.getElementById("detailStateSelect");
    const detailCommentInput = document.getElementById("detailCommentInput");
    const detailAttachments  = document.getElementById("detailAttachments");
    const detailFileInput    = document.getElementById("detailFileInput");
    const detailTimeline     = document.getElementById("detailTimeline");
    let currentIncId         = "";

    // ‚Äî Funciones auxiliares ‚Äî
    function clearStatus(){
      statusEl.innerText = "";
      statusEl.className = "";
    }
    function updateStatus(msg, cls){
      statusEl.innerText = t(msg);
      statusEl.className = cls;
      setTimeout(clearStatus, 5000);
    }
    function showToast(msg, type){
      toast.innerText = t(msg);
      toast.className = `show ${type}`;
      setTimeout(() => toast.className = "", 3000);
    }
    function sanitizeInput(v){
      return v.replace(/[^0-9a-zA-Z]/g, "-");
    }
    function formatDateTime(iso){
      const d = new Date(iso);
      const pad = n => n.toString().padStart(2, "0");
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${pad(d.getFullYear())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // ‚Äî Manejo de vistas ‚Äî
    function showView(v){
      ["view-escaneo","view-historial","view-incidencias","view-reportes","view-ajustes"]
        .forEach(id =>
          document.getElementById(id).style.display = id===v?"block":"none"
        );
      // Cargar contenedores al mostrar reportes
      if (v === "view-reportes") {
        loadContenedoresReport();
      }
    }
    document.getElementById("nav-escaneo").onclick   = ()=>showView("view-escaneo");
    document.getElementById("nav-historial").onclick = ()=>showView("view-historial");
    document.getElementById("nav-incidencias").onclick = ()=>{
      showView("view-incidencias");
      loadIncidencias();
    };
    document.getElementById("nav-reportes").onclick = ()=>showView("view-reportes");
    document.getElementById("nav-ajustes").onclick  = ()=>showView("view-ajustes");

    // ‚Äî Scanner widget ‚Äî
    modeSelect.addEventListener("change", ()=>{
      mode = modeSelect.value;
      document.getElementById("mode").innerHTML =
        `Modo actual: <strong>${modeSelect.selectedOptions[0].text}</strong>`;
      clearStatus();
    });
    ["beforeinput","input","paste","keyup"].forEach(e=>
      barcodeInput.addEventListener(e, ()=> barcodeInput.value=sanitizeInput(barcodeInput.value))
    );
    setInterval(()=>{
      const v = sanitizeInput(barcodeInput.value);
      if(barcodeInput.value!==v) barcodeInput.value=v;
    },25);

    barcodeInput.addEventListener("keydown", e=>{
      if(e.key==="Enter"){
        e.preventDefault();
        setTimeout(async ()=>{
          const code = sanitizeInput(barcodeInput.value.trim());
          if(!code) return updateStatus("Por favor, escanea un c√≥digo v√°lido.","error");
          const endpoint = mode==="recibido"?"/recibido":`/${mode}`;
          try{
            const res = await fetch(
              `https://servidor-backend-paquetes.onrender.com/scanner${endpoint}`, {
                method: mode==="recibido"?"POST":"PUT",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({ paquete_id:code })
              }
            );
            if(res.ok){
              updateStatus("Operaci√≥n correcta","success");
              showToast(`Paquete ${code} actualizado`,"success");
              loadPage(currentPage);
            } else {
              const { error } = await res.json();
              updateStatus(error,"error");
              showToast(error,"error");
            }
          } catch{
            updateStatus("Error de red.","error");
            showToast("Error de red","error");
          } finally{
            barcodeInput.value="";
          }
        },150);
      }
    });

    // ‚Äî Carga y render del historial ‚Äî
    async function loadPage(page=1){
      currentPage=page;
      let url = `https://servidor-backend-paquetes.onrender.com/scanner/all?page=${page}&pageSize=${pageSize}&sortField=${sortField}&sortOrder=${sortOrder}`;
      if(filterState) url+=`&state=${encodeURIComponent(filterState)}`;
      try{
        const resp = await fetch(url);
        const { totalItems: total, page: cur, items } = await resp.json();
        totalItems=total; currentPage=cur;
        tableData=items.map(p=>{
          const h=p.historial;
          return {
            timeISO:h[h.length-1].fecha,
            time:formatDateTime(h[h.length-1].fecha),
            id:p.paquete_id,
            new:p.estado_actual,
            prev:h.length>1?h[h.length-2].estado:"",
            inc:p.incidencias_count
          };
        });
        renderTable(); renderMiniTable();
      } catch(e){
        console.error("Error cargando historial:", e);
      }
    }

    function renderMiniTable(){
      miniTbody.innerHTML="";
      tableData.slice(0,5).forEach(r=>{
        const tr=document.createElement("tr");
        ["time","id","new","prev"].forEach(k=>{
          const td=document.createElement("td");
          td.innerText=r[k]; tr.appendChild(td);
        });
        const tdInc=document.createElement("td");
        tdInc.innerHTML=r.inc>0?`<button class="inc-count" data-id="${r.id}">${r.inc}</button>`:"0";
        tr.appendChild(tdInc);
        const tdA=document.createElement("td");
        tdA.innerHTML=`<button class="${r.inc>0?"mini-view-inc":"mini-report-inc"}" data-id="${r.id}">${r.inc>0?"Ver":"Reportar"} incidencia</button>`;
        tr.appendChild(tdA);
        tr.addEventListener("click", ()=>{
          tr.classList.add("highlight");
          setTimeout(()=>tr.classList.remove("highlight"),500);
        });
        miniTbody.appendChild(tr);
      });
    }

    function renderTable(){
      const start=(currentPage-1)*pageSize+1;
      const end=Math.min(currentPage*pageSize,totalItems);
      counterEl.innerText=`Mostrando ${start}‚Äì${end} de ${totalItems} paquetes`;

      const filtered=tableData.filter(r=>!filterText||r.id.toLowerCase().includes(filterText));

      // Encabezado con checkbox
      scanTbody.parentElement.querySelector("thead")?.remove();
      const thead = document.createElement("thead");
      thead.innerHTML = `<tr>
        <th style='width:32px;'><input type='checkbox' id='selectAllPaqChk'></th>
        <th data-col='time'>${t('Fecha y hora')}</th>
        <th data-col='id'>${t('Paquete')}</th>
        <th data-col='new'>${t('Estado nuevo')}</th>
        <th data-col='prev'>${t('Estado anterior')}</th>
        <th data-col='inc'>${t('Incidencias')}</th>
        <th>${t('Acciones')}</th>
      </tr>`;
      scanTbody.parentElement.insertBefore(thead, scanTbody);

      scanTbody.innerHTML="";
      filtered.forEach(r=>{
        const tr=document.createElement("tr");
        // Checkbox de selecci√≥n
        const tdSel=document.createElement("td");
        tdSel.style='text-align:center;';
        tdSel.innerHTML = `<input type='checkbox' class='sel-paq' data-id='${r.id}' ${selectedPaquetes.has(r.id)?'checked':''}>`;
        tr.appendChild(tdSel);
        ["time","id","new","prev"].forEach(k=>{
          const td=document.createElement("td");
          td.innerText=r[k]; tr.appendChild(td);
        });
        const tdInc=document.createElement("td");
        tdInc.innerHTML=r.inc>0?`<button class="hist-inc-count" data-id="${r.id}">${r.inc}</button>`:"0";
        tr.appendChild(tdInc);
        const tdA=document.createElement("td");
        tdA.innerHTML=`<button class="${r.inc>0?"hist-view-inc":"hist-report-inc"}" data-id="${r.id}">${r.inc>0?"Ver":"Reportar"} incidencia</button>
                       <button class="add-to-cont" data-id="${r.id}">${t("Agregar a contenedor")}</button>
                       <button class="delete-paq" data-id="${r.id}">Eliminar</button>`;
        tr.appendChild(tdA);
        scanTbody.appendChild(tr);
      });

      // Controles de selecci√≥n m√∫ltiple (solo "Eliminar seleccionados" y contador)
      let controls = document.getElementById("multiPaqControls");
      if(!controls){
        controls = document.createElement("div");
        controls.id = "multiPaqControls";
        controls.style = "margin-bottom:8px;";
        scanTbody.parentElement.parentElement.insertBefore(controls, scanTbody.parentElement);
      }
      controls.innerHTML = `<button id='deleteSelectedPaq'>${t('Eliminar seleccionados')}</button>
                            <button id='addSelectedToCont'>${t('Agregar a contenedor')}</button>
                            <span id='paqSelCount'></span>`;
      document.getElementById("deleteSelectedPaq").onclick = async ()=>{
        if(selectedPaquetes.size===0) return showToast("No hay paquetes seleccionados","error");
        if(!confirm(`¬øEliminar ${selectedPaquetes.size} paquetes?`)) return;
        const password = prompt("Introduce la contrase√±a para eliminar los paquetes:");
        if(!password) return;
        let ok=0, fail=0;
        for(const id of selectedPaquetes){
          try{
            const res = await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/paquetes/${id}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password })
            });
            if(res.ok) ok++; else fail++;
          }catch{ fail++; }
        }
        showToast(`Eliminados: ${ok}, Fallidos: ${fail}`,(fail===0?"success":"error"));
        selectedPaquetes.clear();
        loadPage(currentPage);
      };
      document.getElementById("addSelectedToCont").onclick = async ()=>{
        if(selectedPaquetes.size===0) return showToast("No hay paquetes seleccionados","error");
        paquetesParaAgregar = Array.from(selectedPaquetes);
        await abrirModalAgregarContenedor();
      };
      document.getElementById("paqSelCount").innerText = selectedPaquetes.size>0 ? 
        `${selectedPaquetes.size} ${t('seleccionados')}` : '';

      // Checkbox listeners
      scanTbody.querySelectorAll(".sel-paq").forEach(cb=>{
        cb.addEventListener("change",e=>{
          if(e.target.checked) selectedPaquetes.add(e.target.dataset.id);
          else selectedPaquetes.delete(e.target.dataset.id);
          document.getElementById("paqSelCount").innerText = selectedPaquetes.size>0 ? 
            `${selectedPaquetes.size} ${t('seleccionados')}` : '';
          document.getElementById("selectAllPaqChk").checked = selectedPaquetes.size===filtered.length&&filtered.length>0;
        });
      });

      // Selecci√≥n por checkbox de cabecera
      document.getElementById("selectAllPaqChk").onclick = ()=>{
        if(selectedPaquetes.size===filtered.length&&filtered.length>0){
          filtered.forEach(r=>selectedPaquetes.delete(r.id));
        }else{
          filtered.forEach(r=>selectedPaquetes.add(r.id));
        }
        renderTable();
      };

      const totalPages=Math.max(1,Math.ceil(totalItems/pageSize));
      pageInfo.innerText=`P√°gina ${currentPage} de ${totalPages}`;
      prevPageBtn.disabled=currentPage===1;
      nextPageBtn.disabled=currentPage===totalPages;
    }

    // --- Selecci√≥n m√∫ltiple de incidencias ---
    function renderIncTable(){
      const all=filteredInc().sort((a,b)=>{
        const av=a[incSortCol], bv=b[incSortCol];
        if(av<bv) return incSortAsc?-1:1;
        if(av>bv) return incSortAsc?1:-1;
        return 0;
      });
      const start=(incPage-1)*incPageSize+1;
      const end=Math.min(incPage*incPageSize, all.length);
      incPageInfoEl.innerText=`Mostrando ${start}‚Äì${end} de ${all.length} incidencias`;

      // Encabezado con checkbox
      incTbody.parentElement.querySelector("thead")?.remove();
      const thead = document.createElement("thead");
      thead.innerHTML = `<tr>
        <th style='width:32px;'><input type='checkbox' id='selectAllIncChk'></th>
        <th data-col='_id'>${t('ID')}</th>
        <th data-col='paquete_id'>${t('Paquete')}</th>
        <th data-col='tipo'>${t('Tipo')}</th>
        <th data-col='estado'>${t('Estado')}</th>
        <th data-col='fecha_creacion'>${t('Fecha creaci√≥n')}</th>
        <th>${t('Acciones')}</th>
      </tr>`;
      incTbody.parentElement.insertBefore(thead, incTbody);

      incTbody.innerHTML="";
      all.slice(start-1,end).forEach(i=>{
        const tr=document.createElement("tr");
        // Checkbox de selecci√≥n
        const tdSel=document.createElement("td");
        tdSel.style='text-align:center;';
        tdSel.innerHTML = `<input type='checkbox' class='sel-inc' data-id='${i._id}' ${selectedIncidencias.has(i._id)?'checked':''}>`;
        tr.appendChild(tdSel);
        ["_id","paquete_id"].forEach(k=>{
          const td=document.createElement("td");
          td.innerText = i[k]; tr.appendChild(td);
        });
        const tdTipo = document.createElement("td");
        tdTipo.innerText = t(i.tipo);
        tr.appendChild(tdTipo);

        const tdEst=document.createElement("td");
        tdEst.innerHTML=`<span style="color:${i.estado==="Abierta"?"red":i.estado==="En proceso"?"orange":"green"}">${t(i.estado)}</span>`;
        tr.appendChild(tdEst);

        const tdDate=document.createElement("td");
        tdDate.innerText=formatDateTime(i.fecha_creacion);
        tr.appendChild(tdDate);

        const tdA=document.createElement("td");
        tdA.innerHTML=`<button class="view-inc" data-id="${i._id}">${t('Ver incidencia')}</button> <button class="delete-inc" data-id="${i._id}">${t('Eliminar')}</button>`;
        tr.appendChild(tdA);
        incTbody.appendChild(tr);
      });

      // Controles de selecci√≥n m√∫ltiple (solo "Eliminar seleccionados" y contador) - ahora arriba de la tabla
      let controls = document.getElementById("multiIncControls");
      if(!controls){
        controls = document.createElement("div");
        controls.id = "multiIncControls";
        controls.style = "margin-bottom:8px;";
        incTbody.parentElement.parentElement.insertBefore(controls, incTbody.parentElement);
      }
      controls.innerHTML = `<button id='deleteSelectedInc'>${t('Eliminar seleccionados')}</button> <span id='incSelCount'></span>`;
      document.getElementById("deleteSelectedInc").onclick = async ()=>{
        if(selectedIncidencias.size===0) return showToast("No hay incidencias seleccionadas","error");
        if(!confirm(`¬øEliminar ${selectedIncidencias.size} incidencias?`)) return;
        const password = prompt("Introduce la contrase√±a para eliminar las incidencias:");
        if(!password) return;
        let ok=0, fail=0;
        for(const id of selectedIncidencias){
          try{
            const res = await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/incidencias/${id}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password })
            });
            if(res.ok) ok++; else fail++;
          }catch{ fail++; }
        }
        showToast(`Eliminadas: ${ok}, Fallidas: ${fail}`,(fail===0?"success":"error"));
        selectedIncidencias.clear();
        loadIncidencias();
      };
      document.getElementById("incSelCount").innerText = selectedIncidencias.size>0 ? 
        `${selectedIncidencias.size} ${t('seleccionadas')}` : '';

      // Checkbox listeners
      incTbody.querySelectorAll(".sel-inc").forEach(cb=>{
        cb.addEventListener("change",e=>{
          if(e.target.checked) selectedIncidencias.add(e.target.dataset.id);
          else selectedIncidencias.delete(e.target.dataset.id);
          document.getElementById("incSelCount").innerText = selectedIncidencias.size>0 ? 
            `${selectedIncidencias.size} ${t('seleccionadas')}` : '';
          document.getElementById("selectAllIncChk").checked = selectedIncidencias.size===all.length&&all.length>0;
        });
      });

      // Selecci√≥n por checkbox de cabecera
      document.getElementById("selectAllIncChk").onclick = ()=>{
        if(selectedIncidencias.size===all.length&&all.length>0){
          all.forEach(i=>selectedIncidencias.delete(i._id));
        }else{
          all.forEach(i=>selectedIncidencias.add(i._id));
        }
        renderIncTable();
      };

      const maxP=Math.max(1, Math.ceil(filteredInc().length/incPageSize));
      incPrevBtn.disabled=incPage===1;
      incNextBtn.disabled=incPage===maxP;
    }

    // Manejo de eliminaci√≥n de paquete
    scanTbody.addEventListener("click", async e=>{
      if(e.target.matches(".delete-paq")){
        const id = e.target.dataset.id;
        const password = prompt("Introduce la contrase√±a para eliminar el paquete:");
        if(!password) return;
        try{
          const res = await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/paquetes/${id}`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password })
          });
          const j = await res.json();
          if(res.ok){
            showToast("Paquete eliminado correctamente","success");
            loadPage(currentPage);
          }else{
            showToast(j.error||"Error al eliminar paquete","error");
          }
        }catch{
          showToast("Error de red","error");
        }
      }
    });

    // ‚Äî Orden y filtro ‚Äî
    document.querySelectorAll("#scanTable th[data-col]").forEach(th=>{
      th.addEventListener("click", ()=>{
        const c=th.dataset.col;
        if(sortField===c) sortOrder=sortOrder==="asc"?"desc":"asc";
        else{ sortField=c; sortOrder="asc"; }
        loadPage(1);
      });
    });
    stateFilter.addEventListener("change", e=>{
      filterState=e.target.value;
      loadPage(1);
    });
    searchInput.addEventListener("input", e=>{
      filterText=e.target.value.toLowerCase();
      renderTable();
    });
    prevPageBtn.addEventListener("click", ()=>{ if(currentPage>1) loadPage(currentPage-1); });
    nextPageBtn.addEventListener("click", ()=>{ const tp=Math.ceil(totalItems/pageSize); if(currentPage<tp) loadPage(currentPage+1); });

    // ‚Äî Incidencias y modal de reporte ‚Äî
    function attachRowClicks(sel){
      document.querySelector(sel).addEventListener("click", e=>{
        const id=e.target.dataset.id;
        if(!id) return;
        if(e.target.matches(".inc-count")||
           e.target.matches(".mini-view-inc")||
           e.target.matches(".hist-view-inc")){
          showView("view-incidencias");
          document.getElementById("incSearch").value=id;
          incFilterText=id.toLowerCase();
          loadIncidencias();
        } else if(e.target.matches(".mini-report-inc")||
                  e.target.matches(".hist-report-inc")){
          incPaquete.value=id;
          modal.style.display="flex";
        } else if(e.target.matches(".add-to-cont")){
          paquetesParaAgregar = [id];
          abrirModalAgregarContenedor();
        }
      });
    }
    attachRowClicks("#miniTable");
    attachRowClicks("#scanTable");

    // Limpiar formulario de incidencia
    function clearIncForm() {
      incPaquete.value = "";
      incTipo.value = "";
      incDesc.value = "";
      incAdjuntos.value = "";
      // Limpiar lista visual de archivos preadjuntos si existe
      const preList = document.getElementById("incAdjuntosList");
      if (preList) preList.innerHTML = "";
    }

    // Mostrar lista de archivos preadjuntos con opci√≥n de eliminar
    if (!document.getElementById("incAdjuntosList")) {
      const list = document.createElement("div");
      list.id = "incAdjuntosList";
      incAdjuntos.parentElement.insertBefore(list, incAdjuntos.nextSibling);
    }
    incAdjuntos.addEventListener("change", function() {
      const list = document.getElementById("incAdjuntosList");
      list.innerHTML = "";
      Array.from(incAdjuntos.files).forEach((f, idx) => {
        const fileDiv = document.createElement("div");
        fileDiv.style = "display:flex;align-items:center;gap:4px;";
        fileDiv.innerHTML = `<span>${f.name}</span> <button type='button' class='del-pre-file' data-idx='${idx}' style='color:red;font-weight:bold;'>√ó</button>`;
        list.appendChild(fileDiv);
      });
    });
    document.getElementById("incAdjuntosList").addEventListener("click", function(e) {
      if (e.target.classList.contains("del-pre-file")) {
        const idx = parseInt(e.target.dataset.idx);
        const dt = new DataTransfer();
        Array.from(incAdjuntos.files).forEach((f, i) => { if (i !== idx) dt.items.add(f); });
        incAdjuntos.files = dt.files;
        incAdjuntos.dispatchEvent(new Event("change"));
      }
    });

    incCancel.addEventListener("click", ()=>{ modal.style.display="none"; clearIncForm(); });
    incSave.addEventListener("click", async ()=>{
      const form=new FormData();
      form.append("paquete_id", incPaquete.value);
      form.append("tipo", incTipo.value);
      form.append("descripcion", incDesc.value);
      Array.from(incAdjuntos.files).forEach(f=> form.append("adjuntos", f));
      try{
        const res=await fetch("https://servidor-backend-paquetes.onrender.com/scanner/incidencias", {
          method:"POST", body:form
        });
        const j=await res.json();
        if(res.ok){
          showToast("Incidencia creada correctamente","success");
          modal.style.display="none";
          clearIncForm();
          loadPage(currentPage);
        } else {
          showToast(j.error||"Error al crear incidencia","error");
        }
      } catch{
        showToast("Error de red","error");
      }
    });

    const incTbody      = document.querySelector("#incTable tbody");
    const incPrevBtn    = document.getElementById("incPrev");
    const incNextBtn    = document.getElementById("incNext");
    const incPageInfoEl = document.getElementById("incPageInfo");

    document.getElementById("incSearch")
      .addEventListener("input", e=>{
        incFilterText=e.target.value.toLowerCase();
        incPage=1;
        renderIncTable();
      });
    document.getElementById("incTipoFilter")
      .addEventListener("change", e=>{
        incFilterTipo=e.target.value;
        incPage=1;
        renderIncTable();
      });
    document.getElementById("incEstadoFilter")
      .addEventListener("change", e=>{
        incFilterEstado=e.target.value;
        incPage=1;
        renderIncTable();
      });

    async function loadIncidencias(){
      try{
        const r=await fetch("https://servidor-backend-paquetes.onrender.com/scanner/incidencias");
        incData=await r.json();
        incPage=1;
        renderIncTable();
      } catch(e){
        console.error("Error cargando incidencias:", e);
      }
    }

    function filteredInc(){
      return incData.filter(i=>
        (!incFilterText   || i._id.includes(incFilterText)   || i.paquete_id.toLowerCase().includes(incFilterText)) &&
        (!incFilterTipo   || i.tipo===incFilterTipo) &&
        (!incFilterEstado || i.estado===incFilterEstado)
      );
    }

    function renderIncTable(){
      const all=filteredInc().sort((a,b)=>{
        const av=a[incSortCol], bv=b[incSortCol];
        if(av<bv) return incSortAsc?-1:1;
        if(av>bv) return incSortAsc?1:-1;
        return 0;
      });
      const start=(incPage-1)*incPageSize+1;
      const end=Math.min(incPage*incPageSize, all.length);
      incPageInfoEl.innerText=`Mostrando ${start}‚Äì${end} de ${all.length} incidencias`;

      // Encabezado con checkbox
      incTbody.parentElement.querySelector("thead")?.remove();
      const thead = document.createElement("thead");
      thead.innerHTML = `<tr>
        <th style='width:32px;'><input type='checkbox' id='selectAllIncChk'></th>
        <th data-col='_id'>${t('ID')}</th>
        <th data-col='paquete_id'>${t('Paquete')}</th>
        <th data-col='tipo'>${t('Tipo')}</th>
        <th data-col='estado'>${t('Estado')}</th>
        <th data-col='fecha_creacion'>${t('Fecha creaci√≥n')}</th>
        <th>${t('Acciones')}</th>
      </tr>`;
      incTbody.parentElement.insertBefore(thead, incTbody);

      incTbody.innerHTML="";
      all.slice(start-1,end).forEach(i=>{
        const tr=document.createElement("tr");
        // Checkbox de selecci√≥n
        const tdSel=document.createElement("td");
        tdSel.style='text-align:center;';
        tdSel.innerHTML = `<input type='checkbox' class='sel-inc' data-id='${i._id}' ${selectedIncidencias.has(i._id)?'checked':''}>`;
        tr.appendChild(tdSel);
        ["_id","paquete_id"].forEach(k=>{
          const td=document.createElement("td");
          td.innerText = i[k]; tr.appendChild(td);
        });
        const tdTipo = document.createElement("td");
        tdTipo.innerText = t(i.tipo);
        tr.appendChild(tdTipo);

        const tdEst=document.createElement("td");
        tdEst.innerHTML=`<span style="color:${i.estado==="Abierta"?"red":i.estado==="En proceso"?"orange":"green"}">${t(i.estado)}</span>`;
        tr.appendChild(tdEst);

        const tdDate=document.createElement("td");
        tdDate.innerText=formatDateTime(i.fecha_creacion);
        tr.appendChild(tdDate);

        const tdA=document.createElement("td");
        tdA.innerHTML=`<button class="view-inc" data-id="${i._id}">${t('Ver incidencia')}</button> <button class="delete-inc" data-id="${i._id}">${t('Eliminar')}</button>`;
        tr.appendChild(tdA);
        incTbody.appendChild(tr);
      });

      // Controles de selecci√≥n m√∫ltiple (solo "Eliminar seleccionados" y contador) - ahora arriba de la tabla
      let controls = document.getElementById("multiIncControls");
      if(!controls){
        controls = document.createElement("div");
        controls.id = "multiIncControls";
        controls.style = "margin-bottom:8px;";
        incTbody.parentElement.parentElement.insertBefore(controls, incTbody.parentElement);
      }
      controls.innerHTML = `<button id='deleteSelectedInc'>${t('Eliminar seleccionados')}</button> <span id='incSelCount'></span>`;
      document.getElementById("deleteSelectedInc").onclick = async ()=>{
        if(selectedIncidencias.size===0) return showToast("No hay incidencias seleccionadas","error");
        if(!confirm(`¬øEliminar ${selectedIncidencias.size} incidencias?`)) return;
        const password = prompt("Introduce la contrase√±a para eliminar las incidencias:");
        if(!password) return;
        let ok=0, fail=0;
        for(const id of selectedIncidencias){
          try{
            const res = await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/incidencias/${id}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password })
            });
            if(res.ok) ok++; else fail++;
          }catch{ fail++; }
        }
        showToast(`Eliminadas: ${ok}, Fallidas: ${fail}`,(fail===0?"success":"error"));
        selectedIncidencias.clear();
        loadIncidencias();
      };
      document.getElementById("incSelCount").innerText = selectedIncidencias.size>0 ? 
        `${selectedIncidencias.size} ${t('seleccionadas')}` : '';

      // Checkbox listeners
      incTbody.querySelectorAll(".sel-inc").forEach(cb=>{
        cb.addEventListener("change",e=>{
          if(e.target.checked) selectedIncidencias.add(e.target.dataset.id);
          else selectedIncidencias.delete(e.target.dataset.id);
          document.getElementById("incSelCount").innerText = selectedIncidencias.size>0 ? 
            `${selectedIncidencias.size} ${t('seleccionadas')}` : '';
          document.getElementById("selectAllIncChk").checked = selectedIncidencias.size===all.length&&all.length>0;
        });
      });

      // Selecci√≥n por checkbox de cabecera
      document.getElementById("selectAllIncChk").onclick = ()=>{
        if(selectedIncidencias.size===all.length&&all.length>0){
          all.forEach(i=>selectedIncidencias.delete(i._id));
        }else{
          all.forEach(i=>selectedIncidencias.add(i._id));
        }
        renderIncTable();
      };

      const maxP=Math.max(1, Math.ceil(filteredInc().length/incPageSize));
      incPrevBtn.disabled=incPage===1;
      incNextBtn.disabled=incPage===maxP;
    }

    // Manejo de eliminaci√≥n de incidencia
    incTbody.addEventListener("click", async e=>{
      if(e.target.matches(".delete-inc")){
        const id = e.target.dataset.id;
        const password = prompt("Introduce la contrase√±a para eliminar la incidencia:");
        if(!password) return;
        try{
          const res = await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/incidencias/${id}`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password })
          });
          const j = await res.json();
          if(res.ok){
            showToast("Incidencia eliminada correctamente","success");
            loadIncidencias();
          }else{
            showToast(j.error||"Error al eliminar incidencia","error");
          }
        }catch{
          showToast("Error de red","error");
        }
      }
    });

    // ‚Äî Abrir modal de detalle/incidencia ‚Äî
    document.getElementById("view-incidencias").addEventListener("click", async e=>{
      if(e.target.matches(".view-inc")){
        currentIncId=e.target.dataset.id;
        detailCommentInput.value="";
        detailFileInput.value="";
        try{
          const res=await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/incidencias/${currentIncId}`);
          const inc=await res.json();
          detailStateSelect.value=inc.estado;
          detailAttachments.innerHTML = "";
          if (inc.adjuntos && inc.adjuntos.length > 0) {
            inc.adjuntos.forEach(adj => {
              let url = adj.url || adj;
              let nombre = adj.nombre || "Adjunto";
              const ext = url.split('.').pop().toLowerCase();
              if (["jpg","jpeg","png","gif","bmp","webp"].includes(ext)) {
                const img = document.createElement("img");
                img.src = url;
                img.onclick = () => window.open(url, "_blank");
                img.title = nombre;
                detailAttachments.appendChild(img);
              } else {
                const link = document.createElement("a");
                link.href = url;
                link.target = "_blank";
                link.innerText = nombre;
                link.style.margin = "4px";
                detailAttachments.appendChild(link);
              }
            });
          } else {
            detailAttachments.innerHTML = `<span style="color:#888;">${t('Sin adjuntos')}</span>`;
          }
          // Mostrar comentarios: solo eventos con comentario y sin estado ni adjuntos
          const comments = [];
          // Si hay descripci√≥n, mostrarla como primer comentario
          if (inc.descripcion) {
            comments.push({
              comentario: inc.descripcion,
              fecha: inc.fecha_creacion
            });
          }
          (inc.historial||[]).forEach(ev => {
            if (ev.comentario && !ev.estado && (!ev.adjuntos || ev.adjuntos.length===0)) {
              comments.push(ev);
            }
          });
          const detailComments = document.getElementById("detailComments");
          if (comments.length > 0) {
            detailComments.innerHTML = comments.map(ev =>
              `<div style='margin-bottom:8px;'><span style='color:#333;'>${ev.comentario}</span><br><span style='font-size:0.8em;color:#888;'>${formatDateTime(ev.fecha)}</span></div>`
            ).join("");
          } else {
            detailComments.innerHTML = `<span style="color:#888;">${t('Sin comentarios')}</span>`;
          }
          renderDetailTimeline(inc.historial, inc.fecha_creacion, inc.descripcion);
          detailModal.style.display = "flex";
        } catch{
          showToast("No se pudo cargar la incidencia","error");
        }
      }
    });

    // ‚Äî Guardar todos los cambios (estado, comentario, adjuntos) en un solo bot√≥n ‚Äî
    detailSaveBtn.addEventListener("click", async ()=>{
      detailSaveBtn.disabled=true;
      try{
        const form = new FormData();
        form.append("nuevo_estado", detailStateSelect.value);
        form.append("comentario", detailCommentInput.value);
        Array.from(detailFileInput.files).forEach(f=>form.append("adjuntos",f));
        await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/incidencias/${currentIncId}`, {
          method:"PUT",
          body: form
        });
        showToast("Cambios guardados","success");
        detailModal.style.display="none";
        loadIncidencias();
        detailCommentInput.value = "";
        detailFileInput.value = "";
      }catch(err){
        showToast(err.error||"Error al guardar cambios","error");
      }finally{
        detailSaveBtn.disabled=false;
      }
    });

    // ‚Äî Cerrar modal sin guardar ‚Äî
    detailCloseIcon.addEventListener("click", ()=>{
      detailModal.style.display="none";
    });

    function renderDetailTimeline(historial, fecha_creacion, descripcion){
      // Solo mostrar eventos de estado y adjuntos (no comentarios ni descripci√≥n)
      let timeline = [];
      if (historial && historial.length) {
        timeline = historial.filter(ev => ev.estado || (ev.adjuntos && ev.adjuntos.length > 0));
      }
      detailTimeline.innerHTML = timeline.map(ev => {
        let html = '';
        if (ev.estado) {
          html += `<div><strong>Estado:</strong> ${ev.estado} <span style="font-size:0.8em;color:#666;">${formatDateTime(ev.fecha)}</span></div>`;
        }
        if (ev.adjuntos && Array.isArray(ev.adjuntos) && ev.adjuntos.length > 0) {
          html += `<div><strong>Adjuntos:</strong> `;
          ev.adjuntos.forEach(adj => {
            let url = adj.url || adj;
            let nombre = adj.nombre || "Adjunto";
            const ext = url.split('.').pop().toLowerCase();
            if (["jpg","jpeg","png","gif","bmp","webp"].includes(ext)) {
              html += `<img src="${url}" style="width:50px;vertical-align:middle;margin:2px;cursor:pointer;" onclick="window.open('${url}','_blank')" title="${nombre}" />`;
            } else {
              html += `<a href="${url}" target="_blank" style="margin:2px;">${nombre}</a>`;
            }
          });
          html += ` <span style="font-size:0.8em;color:#666;">${formatDateTime(ev.fecha)}</span></div>`;
        }
        return html;
      }).join("");
    }

    // ‚Äî Inicializaci√≥n ‚Äî
    loadPage(1);
    showView("view-escaneo");


    // --- Alternar modo oscuro/claro ---
    const toggleThemeSwitch = document.getElementById("toggleThemeSwitch");
    // Inicializar el estado del switch seg√∫n localStorage
    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark-mode");
      if (toggleThemeSwitch) toggleThemeSwitch.checked = true;
    }
    if (toggleThemeSwitch) {
      toggleThemeSwitch.onchange = function() {
        if (toggleThemeSwitch.checked) {
          document.body.classList.add("dark-mode");
          localStorage.setItem("theme", "dark");
        } else {
          document.body.classList.remove("dark-mode");
          localStorage.setItem("theme", "light");
        }
      };
    }

    // Traducciones optimizadas y limpias
    const translations = {
      es: {
        // ...solo claves √∫nicas y relevantes...
        "Ajustes": "Ajustes",
        "Configuraci√≥n y preferencias del sistema.": "Configuraci√≥n y preferencias del sistema.",
        "Modo oscuro": "Modo oscuro",
        "Idioma:": "Idioma:",
        "Escaneo": "Escaneo",
        "Historial": "Historial",
        "Incidencias": "Incidencias",
        "Reportes": "Reportes",
        "Scanner de rastreo": "Scanner de rastreo",
        "Selecciona fase:": "Selecciona fase:",
        "Recepci√≥n": "Recepci√≥n",
        "Tr√°nsito": "Tr√°nsito",
        "Almac√©n": "Almac√©n",
        "Recibido": "Recibido",
        "En tr√°nsito nacional MX": "En tr√°nsito nacional MX",
        "En tr√°nsito nacional EU": "En tr√°nsito nacional EU",
        "En tr√°nsito internacional": "En tr√°nsito internacional",
        "En almac√©n EU": "En almac√©n EU",
        "En almac√©n MX": "En almac√©n MX",
        "Escanea o pega el c√≥digo:": "Escanea o pega el c√≥digo:",
        "Escanea el c√≥digo aqu√≠": "Escanea el c√≥digo aqu√≠",
        "Modo actual:": "Modo actual:",
        "√öltimos escaneos": "√öltimos escaneos",
        "Fecha y hora": "Fecha y hora",
        "Paquete": "Paquete",
        "Estado nuevo": "Estado nuevo",
        "Estado anterior": "Estado anterior",
        "Incidencias": "Incidencias",
        "Acciones": "Acciones",
        "Buscar paquete‚Ä¶": "Buscar paquete‚Ä¶",
        "Todos los estados": "Todos los estados",
        "Anterior": "Anterior",
        "Siguiente": "Siguiente",
        "Mostrando": "Mostrando",
        "de": "de",
        "P√°gina": "P√°gina",
        "seleccionados": "seleccionados",
        "Eliminar seleccionados": "Eliminar seleccionados",
        "Reportar": "Reportar",
        "Ver": "Ver",
        "ID": "ID",
        "Tipo": "Tipo",
        "Tipo de incidencia": "Tipo de incidencia",
        "Descripci√≥n": "Descripci√≥n",
        "Adjuntar fotos/documentos": "Adjuntar fotos/documentos",
        "Cancelar": "Cancelar",
        "Guardar": "Guardar",
        "Detalle de Incidencia": "Detalle de Incidencia",
        "Estado": "Estado",
        "Adjuntos existentes": "Adjuntos existentes",
        "Subir nuevos adjuntos": "Subir nuevos adjuntos",
        "Historial de cambios": "Historial de cambios",
        "Comentarios": "Comentarios",
        "Nuevo comentario": "Nuevo comentario",
        "Fecha creaci√≥n": "Fecha creaci√≥n",
        "Abierta": "Abierta",
        "En proceso": "En proceso",
        "Resuelta": "Resuelta",
        "Cerrada": "Cerrada",
        "Rechazada": "Rechazada",
        "Sin comentarios": "Sin comentarios",
        "Sin adjuntos": "Sin adjuntos",
        "Ver incidencia": "Ver incidencia",
        "Eliminar": "Eliminar",
        "seleccionadas": "seleccionadas",
        "Todos los tipos": "Todos los tipos",
        "Da√±ado": "Da√±ado",
        "Falta docs": "Falta docs",
        "Direcci√≥n incorrecta": "Direcci√≥n incorrecta",
        "Cliente ausente": "Cliente ausente",
        "Otro": "Otro",
        "Aqu√≠ se mostrar√°n los reportes y estad√≠sticas del sistema.": "Aqu√≠ se mostrar√°n los reportes y estad√≠sticas del sistema.",
        "Contenedor": "Contenedor",
        "Paquetes": "Paquetes",
        "Incidencias totales": "Incidencias totales",
        "Antig√ºedad": "Antig√ºedad",
        "No hay contenedores registrados.": "No hay contenedores registrados.",
        "Error al cargar contenedores.": "Error al cargar contenedores.",
        "Crear contenedor": "Crear contenedor",
        "Nombre del contenedor": "Nombre del contenedor",
        "Paquetes integrados": "Paquetes integrados",
        "Expandir": "Expandir",
        "Colapsar": "Colapsar",
        "Agregar a contenedor": "Agregar a contenedor",
        "Selecciona contenedor destino": "Selecciona contenedor destino",
        "Agregar": "Agregar",
        "Fecha de creaci√≥n del contenedor": "Fecha de creaci√≥n del contenedor",
        "Fecha del paquete m√°s antiguo": "Fecha del paquete m√°s antiguo"
      },
      en: {
        "Ajustes": "Settings",
        "Configuraci√≥n y preferencias del sistema.": "System settings and preferences.",
        "Modo oscuro": "Dark mode",
        "Idioma:": "Language:",
        "Escaneo": "Scan",
        "Historial": "History",
        "Incidencias": "Incidents",
        "Reportes": "Reports",
        "Scanner de rastreo": "Tracking scanner",
        "Selecciona fase:": "Select phase:",
        "Recepci√≥n": "Reception",
        "Tr√°nsito": "Transit",
        "Almac√©n": "Warehouse",
        "Recibido": "Received",
        "En tr√°nsito nacional MX": "In national transit MX",
        "En tr√°nsito nacional EU": "In national transit US",
        "En tr√°nsito internacional": "In international transit",
        "En almac√©n EU": "In warehouse US",
        "En almac√©n MX": "In warehouse MX",
        "Escanea o pega el c√≥digo:": "Scan or paste the code:",
        "Escanea el c√≥digo aqu√≠": "Scan the code here",
        "Modo actual:": "Current mode:",
        "√öltimos escaneos": "Latest scans",
        "Fecha y hora": "Date & Time",
        "Paquete": "Package",
        "Estado nuevo": "New status",
        "Estado anterior": "Previous status",
        "Incidencias": "Incidents",
        "Acciones": "Actions",
        "Buscar paquete‚Ä¶": "Search package‚Ä¶",
        "Todos los estados": "All statuses",
        "Anterior": "Previous",
        "Siguiente": "Next",
        "Mostrando": "Showing",
        "de": "of",
        "P√°gina": "Page",
        "seleccionados": "selected",
        "Eliminar seleccionados": "Delete selected",
        "Reportar": "Report",
        "Ver": "View",
        "ID": "ID",
        "Tipo": "Type",
        "Tipo de incidencia": "Incident type",
        "Descripci√≥n": "Description",
        "Adjuntar fotos/documentos": "Attach photos/documents",
        "Cancelar": "Cancel",
        "Guardar": "Save",
        "Detalle de Incidencia": "Incident details",
        "Estado": "Status",
        "Adjuntos existentes": "Existing attachments",
        "Subir nuevos adjuntos": "Upload new attachments",
        "Historial de cambios": "Change history",
        "Comentarios": "Comments",
        "Nuevo comentario": "New comment",
        "Fecha creaci√≥n": "Creation date",
        "Abierta": "Open",
        "En proceso": "In progress",
        "Resuelta": "Resolved",
        "Cerrada": "Closed",
        "Rechazada": "Rejected",
        "Sin comentarios": "No comments",
        "Sin adjuntos": "No attachments",
        "Ver incidencia": "View incident",
        "Eliminar": "Delete",
        "seleccionadas": "selected",
        "Todos los tipos": "All types",
        "Da√±ado": "Damaged",
        "Falta docs": "Missing docs",
        "Direcci√≥n incorrecta": "Wrong address",
        "Cliente ausente": "Absent client",
        "Otro": "Other",
        "Aqu√≠ se mostrar√°n los reportes y estad√≠sticas del sistema.": "Reports and statistics will be shown here.",
        "Contenedor": "Container",
        "Paquetes": "Packages",
        "Incidencias totales": "Total incidents",
        "Antig√ºedad": "Age",
        "No hay contenedores registrados.": "No containers registered.",
        "Error al cargar contenedores.": "Error loading containers.",
        "Crear contenedor": "Create container",
        "Nombre del contenedor": "Container name",
        "Paquetes integrados": "Integrated packages",
        "Expandir": "Expand",
        "Colapsar": "Collapse",
        "Agregar a contenedor": "Add to container",
        "Selecciona contenedor destino": "Select destination container",
        "Agregar": "Add",
        "Fecha de creaci√≥n del contenedor": "Container creation date",
        "Fecha del paquete m√°s antiguo": "Oldest package date"
      }
    };

    let currentLang = localStorage.getItem("lang") || "es";
    function t(str) { return translations[currentLang][str] || str; }

    // Traduce todos los selectores y opciones, incluyendo optgroup y option
    function updateSelectors() {
      // Traducir select de fases (escaneo)
      const modeSelect = document.getElementById("modeSelect");
      Array.from(modeSelect.children).forEach(optgroup => {
        if (optgroup.tagName === "OPTGROUP") {
          optgroup.label = t(optgroup.label);
          Array.from(optgroup.children).forEach(option => {
            option.text = t(option.text);
          });
        }
      });

      // Traducir select de filtro de estados (historial)
      const stateFilter = document.getElementById("stateFilter");
      Array.from(stateFilter.children).forEach(child => {
        if (child.tagName === "OPTION") {
          child.text = t(child.text);
        } else if (child.tagName === "OPTGROUP") {
          child.label = t(child.label);
          Array.from(child.children).forEach(option => {
            option.text = t(option.text);
          });
        }
      });

      // Traducir select de tipo de incidencia (modal)
      const incTipo = document.getElementById("incTipo");
      Array.from(incTipo.options).forEach(opt => {
        opt.text = opt.value ? t(opt.text) : t("-- Seleccione --");
      });

      // Traducir select de filtro de tipo de incidencia (tabla)
      const incTipoFilter = document.getElementById("incTipoFilter");
      Array.from(incTipoFilter.options).forEach(opt => {
        opt.text = opt.value ? t(opt.text) : t("Todos los tipos");
      });

      // Traducir select de filtro de estado de incidencia (tabla)
      const incEstadoFilter = document.getElementById("incEstadoFilter");
      Array.from(incEstadoFilter.options).forEach(opt => {
        opt.text = opt.value ? t(opt.text) : t("Todos los estados");
      });

      // Traducir select de estado en modal de detalle
      const detailStateSelect = document.getElementById("detailStateSelect");
      Array.from(detailStateSelect.options).forEach(opt => {
        opt.text = t(opt.text);
      });
    }

    // Traduce todos los textos visibles y placeholders
    function applyTranslations() {
      // T√≠tulo de la p√°gina
      document.title = t("Scanner de rastreo");
      document.querySelector("header h1").innerText = t("Scanner de rastreo");
      
      // Ajustes
      document.getElementById("settingsTitle").innerText = t("Ajustes");
      document.getElementById("settingsDesc").innerText = t("Configuraci√≥n y preferencias del sistema.");
      document.getElementById("themeLabel").innerText = t("Modo oscuro");
      document.getElementById("langLabel").innerText = t("Idioma:");
      // Men√∫ lateral
      document.getElementById("nav-escaneo").innerHTML = `<span class="icon">üîç</span>${t("Escaneo")}`;
      document.getElementById("nav-historial").innerHTML = `<span class="icon">üìú</span>${t("Historial")}`;
      document.getElementById("nav-incidencias").innerHTML = `<span class="icon">‚ö†Ô∏è</span>${t("Incidencias")}`;
      document.getElementById("nav-reportes").innerHTML = `<span class="icon">üìä</span>${t("Reportes")}`;
      document.getElementById("nav-ajustes").innerHTML = `<span class="icon">‚öôÔ∏è</span>${t("Ajustes")}`;
      // Placeholders y botones
      document.getElementById("barcodeInput").placeholder = t("Escanea el c√≥digo aqu√≠");
      document.getElementById("searchInput").placeholder = t("Buscar paquete‚Ä¶");
      document.getElementById("incSearch").placeholder = t("Buscar paquete‚Ä¶");
      // Traducir textos de reportes
      document.querySelector("#view-reportes h2").innerText = t("Reportes");
      document.getElementById("contenedoresLoading").innerText = t("Cargando contenedores...");
      document.getElementById("btnCrearContenedor").innerText = t("Crear contenedor");
      document.getElementById("crearContenedorTitulo").innerText = t("Crear contenedor");
      document.getElementById("labelNombreContenedor").innerText = t("Nombre del contenedor");
      document.getElementById("btnCancelarCrearContenedor").innerText = t("Cancelar");
      document.getElementById("btnGuardarCrearContenedor").innerText = t("Guardar");
      // Modal agregar a contenedor
      document.getElementById("agregarContenedorTitulo").innerText = t("Agregar a contenedor");
      document.getElementById("labelContenedorDestino").innerText = t("Selecciona contenedor destino");
      document.getElementById("btnCancelarAgregarContenedor").innerText = t("Cancelar");
      document.getElementById("btnGuardarAgregarContenedor").innerText = t("Agregar");
    }

    // Al cambiar idioma, traducir todo
    const langSelect = document.getElementById("langSelect");
    langSelect.value = currentLang;
    langSelect.onchange = function() {
      currentLang = langSelect.value;
      localStorage.setItem("lang", currentLang);
      applyTranslations();
      updateSelectors();
      renderIncTable();
      renderTable();
      loadPage(currentPage);
      loadContenedoresReport(); // <-- recarga los contenedores en el idioma seleccionado
    };

    // Al cargar la p√°gina, cargar contenedores si la vista es reportes
    document.addEventListener("DOMContentLoaded", function() {
      currentLang = localStorage.getItem("lang") || "es";
      document.getElementById("langSelect").value = currentLang;
      applyTranslations();
      updateSelectors();
      if(tableData.length > 0) renderTable();
      if(incData.length > 0) renderIncTable();
      // Si la vista inicial es reportes, cargar contenedores
      if (document.getElementById("view-reportes").style.display !== "none") {
        loadContenedoresReport();
      }
    });

    // --- Reportes: cargar contenedores siempre y ordenar por fecha m√°s reciente ---
    async function loadContenedoresReport() {
      const loading = document.getElementById("contenedoresLoading");
      const cards = document.getElementById("contenedoresCards");
      loading.style.display = "block";
      cards.innerHTML = "";
      try {
        // Obtener todos los contenedores
        const res = await fetch("https://servidor-backend-paquetes.onrender.com/scanner/contenedor/all");
        let data = await res.json();
        // Ordenar por fecha_creacion descendente (m√°s recientes primero)
        data = Array.isArray(data) ? data.sort((a, b) => new Date(b.fecha_creacion || 0) - new Date(a.fecha_creacion || 0)) : [];
        if (!Array.isArray(data) || data.length === 0) {
          loading.innerText = t("No hay contenedores registrados.");
          return;
        }
        loading.style.display = "none";
        // Para cada contenedor, obtener datos de paquetes y calcular incidencias y antig√ºedad
        for (const cont of data) {
          // Obtener detalles de paquetes
          let paquetes = cont.paquetes || [];
          let paquetesData = [];
          let incidenciasTotales = 0;
          let fechaMasAntigua = null;
          let fechaMasAntiguaStr = "N/A";
          if (paquetes.length > 0) {
            // Obtener datos de paquetes y sus incidencias
            const paquetesRes = await fetch("https://servidor-backend-paquetes.onrender.com/scanner/paquetes/detalles", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paquetes })
            });
            paquetesData = await paquetesRes.json();
            // Calcular incidencias y fecha m√°s antigua
            for (const p of paquetesData) {
              incidenciasTotales += p.incidencias_count || 0;
              const fecha = new Date(p.fecha_creacion || p.historial?.[0]?.fecha);
              if (!fechaMasAntigua || fecha < fechaMasAntigua) fechaMasAntigua = fecha;
            }
            if (fechaMasAntigua) {
              fechaMasAntiguaStr = formatDateTime(fechaMasAntigua.toISOString());
            }
          }
          // Fecha de creaci√≥n del contenedor
          let fechaContenedorStr = "N/A";
          if (cont.fecha_creacion) {
            fechaContenedorStr = formatDateTime(cont.fecha_creacion);
          }
          // Calcular antig√ºedad
          let tiempo = "N/A";
          if (fechaMasAntigua) {
            const ms = Date.now() - fechaMasAntigua.getTime();
            const dias = Math.floor(ms / (1000*60*60*24));
            const horas = Math.floor((ms % (1000*60*60*24)) / (1000*60*60));
            tiempo = dias > 0 ? `${dias}d ${horas}h` : `${horas}h`;
          }
          // Tarjeta con fechas
          const card = document.createElement("div");
          card.style = "background:#fff;border:1px solid #ccc;border-radius:8px;padding:18px;min-width:220px;max-width:260px;box-shadow:0 2px 8px #0001;display:flex;flex-direction:column;gap:8px;position:relative;";
          card.innerHTML = `
            <div style="font-weight:bold;font-size:1.1em;">${t("Contenedor")}: ${cont.contenedor_id}</div>
            <div>${t("Paquetes")}: <strong>${paquetes.length}</strong></div>
            <div>${t("Incidencias totales")}: <strong>${incidenciasTotales}</strong></div>
            <div>${t("Antig√ºedad")}: <strong>${tiempo}</strong></div>
            <div>${t("Fecha de creaci√≥n del contenedor")}: <strong>${fechaContenedorStr}</strong></div>
            <div>${t("Fecha del paquete m√°s antiguo")}: <strong>${fechaMasAntiguaStr}</strong></div>
            <button class="btn-expand" style="margin-top:8px;">${t("Expandir")}</button>
            <div class="contenedor-paquetes-detalle" style="display:none;margin-top:10px;">
              <div style="font-weight:bold;margin-bottom:6px;">${t("Paquetes integrados")}:</div>
              <ul style="padding-left:18px;margin:0;">
                ${paquetesData.map(p => `<li>${t("Paquete")}: <strong>${p.paquete_id}</strong> (${t("Estado")}: ${t(p.historial?.[p.historial.length-1]?.estado || "")})</li>`).join("")}
              </ul>
              <button class="btn-collapse" style="margin-top:8px;">${t("Colapsar")}</button>
            </div>
          `;
          card.querySelector(".btn-expand").onclick = function() {
            card.querySelector(".contenedor-paquetes-detalle").style.display = "block";
            this.style.display = "none";
          };
          card.querySelector(".btn-collapse").onclick = function() {
            card.querySelector(".contenedor-paquetes-detalle").style.display = "none";
            card.querySelector(".btn-expand").style.display = "inline-block";
          };
          cards.appendChild(card);
        }
      } catch (e) {
        loading.innerText = t("Error al cargar contenedores.");
      }
    }

    // --- Modal crear contenedor ---
    const modalCrearContenedor = document.getElementById("modalCrearContenedor");
    const btnCrearContenedor = document.getElementById("btnCrearContenedor");
    const btnCancelarCrearContenedor = document.getElementById("btnCancelarCrearContenedor");
    const btnGuardarCrearContenedor = document.getElementById("btnGuardarCrearContenedor");
    const inputNombreContenedor = document.getElementById("inputNombreContenedor");

    btnCrearContenedor.onclick = () => {
      inputNombreContenedor.value = "";
      modalCrearContenedor.style.display = "flex";
    };
    btnCancelarCrearContenedor.onclick = () => {
      modalCrearContenedor.style.display = "none";
    };
    btnGuardarCrearContenedor.onclick = async () => {
      const nombre = inputNombreContenedor.value.trim();
      if (!nombre) {
        showToast("Debes ingresar un nombre para el contenedor", "error");
        return;
      }
      try {
        const res = await fetch("https://servidor-backend-paquetes.onrender.com/scanner/contenedor/agregar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contenedor_id: nombre, paquetes: [] })
        });
        if (res.ok) {
          showToast("Contenedor creado correctamente", "success");
          modalCrearContenedor.style.display = "none";
          loadContenedoresReport();
        } else {
          const j = await res.json();
          showToast(j.error || "Error al crear contenedor", "error");
        }
      } catch {
        showToast("Error de red", "error");
      }
    };

    // --- Modal agregar a contenedor ---
    const modalAgregarContenedor = document.getElementById("modalAgregarContenedor");
    const btnCancelarAgregarContenedor = document.getElementById("btnCancelarAgregarContenedor");
    const btnGuardarAgregarContenedor = document.getElementById("btnGuardarAgregarContenedor");
    const selectContenedorDestino = document.getElementById("selectContenedorDestino");

    let paquetesParaAgregar = [];

    // Bot√≥n en controles de historial (multi-selecci√≥n)
    function renderTable() {
      const start=(currentPage-1)*pageSize+1;
      const end=Math.min(currentPage*pageSize,totalItems);
      counterEl.innerText=`Mostrando ${start}‚Äì${end} de ${totalItems} paquetes`;

      const filtered=tableData.filter(r=>!filterText||r.id.toLowerCase().includes(filterText));

      // Encabezado con checkbox
      scanTbody.parentElement.querySelector("thead")?.remove();
      const thead = document.createElement("thead");
      thead.innerHTML = `<tr>
        <th style='width:32px;'><input type='checkbox' id='selectAllPaqChk'></th>
        <th data-col='time'>${t('Fecha y hora')}</th>
        <th data-col='id'>${t('Paquete')}</th>
        <th data-col='new'>${t('Estado nuevo')}</th>
        <th data-col='prev'>${t('Estado anterior')}</th>
        <th data-col='inc'>${t('Incidencias')}</th>
        <th>${t('Acciones')}</th>
      </tr>`;
      scanTbody.parentElement.insertBefore(thead, scanTbody);

      scanTbody.innerHTML="";
      filtered.forEach(r=>{
        const tr=document.createElement("tr");
        // Checkbox de selecci√≥n
        const tdSel=document.createElement("td");
        tdSel.style='text-align:center;';
        tdSel.innerHTML = `<input type='checkbox' class='sel-paq' data-id='${r.id}' ${selectedPaquetes.has(r.id)?'checked':''}>`;
        tr.appendChild(tdSel);
        ["time","id","new","prev"].forEach(k=>{
          const td=document.createElement("td");
          td.innerText=r[k]; tr.appendChild(td);
        });
        const tdInc=document.createElement("td");
        tdInc.innerHTML=r.inc>0?`<button class="hist-inc-count" data-id="${r.id}">${r.inc}</button>`:"0";
        tr.appendChild(tdInc);
        const tdA=document.createElement("td");
        tdA.innerHTML=`<button class="${r.inc>0?"hist-view-inc":"hist-report-inc"}" data-id="${r.id}">${r.inc>0?"Ver":"Reportar"} incidencia</button>
                       <button class="add-to-cont" data-id="${r.id}">${t("Agregar a contenedor")}</button>
                       <button class="delete-paq" data-id="${r.id}">Eliminar</button>`;
        tr.appendChild(tdA);
        tr.addEventListener("click", ()=>{
          tr.classList.add("highlight");
          setTimeout(()=>tr.classList.remove("highlight"),500);
        });
        scanTbody.appendChild(tr);
      });

      // Controles de selecci√≥n m√∫ltiple (solo "Eliminar seleccionados" y contador)
      let controls = document.getElementById("multiPaqControls");
      if(!controls){
        controls = document.createElement("div");
        controls.id = "multiPaqControls";
        controls.style = "margin-bottom:8px;";
        scanTbody.parentElement.parentElement.insertBefore(controls, scanTbody.parentElement);
      }
      controls.innerHTML = `<button id='deleteSelectedPaq'>${t('Eliminar seleccionados')}</button>
                            <button id='addSelectedToCont'>${t('Agregar a contenedor')}</button>
                            <span id='paqSelCount'></span>`;
      document.getElementById("deleteSelectedPaq").onclick = async ()=>{
        if(selectedPaquetes.size===0) return showToast("No hay paquetes seleccionados","error");
        if(!confirm(`¬øEliminar ${selectedPaquetes.size} paquetes?`)) return;
        const password = prompt("Introduce la contrase√±a para eliminar los paquetes:");
        if(!password) return;
        let ok=0, fail=0;
        for(const id of selectedPaquetes){
          try{
            const res = await fetch(`https://servidor-backend-paquetes.onrender.com/scanner/paquetes/${id}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password })
            });
            if(res.ok) ok++; else fail++;
          }catch{ fail++; }
        }
        showToast(`Eliminados: ${ok}, Fallidos: ${fail}`,(fail===0?"success":"error"));
        selectedPaquetes.clear();
        loadPage(currentPage);
      };
      document.getElementById("addSelectedToCont").onclick = async ()=>{
        if(selectedPaquetes.size===0) return showToast("No hay paquetes seleccionados","error");
        paquetesParaAgregar = Array.from(selectedPaquetes);
        await abrirModalAgregarContenedor();
      };
      document.getElementById("paqSelCount").innerText = selectedPaquetes.size>0 ? 
        `${selectedPaquetes.size} ${t('seleccionados')}` : '';

      // Checkbox listeners
      scanTbody.querySelectorAll(".sel-paq").forEach(cb=>{
        cb.addEventListener("change",e=>{
          if(e.target.checked) selectedPaquetes.add(e.target.dataset.id);
          else selectedPaquetes.delete(e.target.dataset.id);
          document.getElementById("paqSelCount").innerText = selectedPaquetes.size>0 ? 
            `${selectedPaquetes.size} ${t('seleccionados')}` : '';
          document.getElementById("selectAllPaqChk").checked = selectedPaquetes.size===filtered.length&&filtered.length>0;
        });
      });

      // Selecci√≥n por checkbox de cabecera
      document.getElementById("selectAllPaqChk").onclick = ()=>{
        if(selectedPaquetes.size===filtered.length&&filtered.length>0){
          filtered.forEach(r=>selectedPaquetes.delete(r.id));
        }else{
          filtered.forEach(r=>selectedPaquetes.add(r.id));
        }
        renderTable();
      };

      const totalPages=Math.max(1,Math.ceil(totalItems/pageSize));
      pageInfo.innerText=`P√°gina ${currentPage} de ${totalPages}`;
      prevPageBtn.disabled=currentPage===1;
      nextPageBtn.disabled=currentPage===totalPages;
    }

    // Bot√≥n individual en cada fila
    scanTbody.addEventListener("click", async e=>{
      // ...existing code...
      if(e.target.matches(".add-to-cont")){
        paquetesParaAgregar = [e.target.dataset.id];
        abrirModalAgregarContenedor();
      }
      // ...existing code...
    });

    // Abrir modal y cargar contenedores
    async function abrirModalAgregarContenedor() {
      selectContenedorDestino.innerHTML = "";
      try {
        const res = await fetch("https://servidor-backend-paquetes.onrender.com/scanner/contenedor/all");
        const conts = await res.json();
        conts.forEach(c=>{
          const opt = document.createElement("option");
          opt.value = c.contenedor_id;
          opt.text = c.contenedor_id;
          selectContenedorDestino.appendChild(opt);
        });
        modalAgregarContenedor.style.display = "flex";
      } catch {
        showToast("Error al cargar contenedores", "error");
      }
    }
    btnCancelarAgregarContenedor.onclick = () => {
      modalAgregarContenedor.style.display = "none";
      paquetesParaAgregar = [];
    };
    btnGuardarAgregarContenedor.onclick = async () => {
      const destino = selectContenedorDestino.value;
      if (!destino) {
        showToast("Selecciona un contenedor destino", "error");
        return;
      }
      try {
        const res = await fetch("https://servidor-backend-paquetes.onrender.com/scanner/contenedor/agregar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contenedor_id: destino, paquetes: paquetesParaAgregar })
        });
        if (res.ok) {
          showToast("Paquetes agregados correctamente", "success");
          modalAgregarContenedor.style.display = "none";
          paquetesParaAgregar = [];
          loadContenedoresReport();
        } else {
          const j = await res.json();
          showToast(j.error || "Error al agregar paquetes", "error");
        }
      } catch {
        showToast("Error de red", "error");
      }
    };

    // Traducciones extra
    translations.es["Agregar a contenedor"] = "Agregar a contenedor";
    translations.en["Agregar a contenedor"] = "Add to container";
    translations.es["Selecciona contenedor destino"] = "Selecciona contenedor destino";
    translations.en["Selecciona contenedor destino"] = "Select destination container";
    translations.es["Agregar"] = "Agregar";
    translations.en["Agregar"] = "Add";
    translations.es["Fecha de creaci√≥n del contenedor"] = "Fecha de creaci√≥n del contenedor";
    translations.en["Fecha de creaci√≥n del contenedor"] = "Container creation date";
    translations.es["Fecha del paquete m√°s antiguo"] = "Fecha del paquete m√°s antiguo";
    translations.en["Fecha del paquete m√°s antiguo"] = "Oldest package date";
  </script>
</body>
</html>
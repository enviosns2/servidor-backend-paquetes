<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scanner de rastreo</title>
  <style>
    /* Layout */
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 60px;
      background: #333;
      color: #fff;
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
    }
    header .logo img {
      height: 40px;
      margin-right: 20px;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }
    #container {
      display: flex;
      flex: 1;
      padding-top: 60px; /* espacio para header */
    }
    aside {
      width: 20%;
      background: #f4f4f4;   /* vuelto al color original */
      padding: 20px;
      box-sizing: border-box;
    }
    aside nav a {
      display: flex;
      align-items: center;
      padding: 8px 0;
      color: #333;
      text-decoration: none;
    }
    aside nav a .icon {
      margin-right: 8px;
    }
    main {
      flex: 1;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    /* Scanner widget */
    #scannerWidget {
      background: #fafafa;    /* vuelto al color original */
      padding: 15px;
      border: 1px solid #ddd;
      margin-bottom: 30px;
    }
    #scannerWidget label,
    #scannerWidget select,
    #scannerWidget input {
      display: block;
      width: 100%;
      margin-bottom: 10px;
    }
    #status {
      margin-top: 10px;
      font-size: 0.95rem;
    }
    .success { color: green; }
    .error   { color: red; }

    /* Toast */
    #toast {
      position: fixed;
      top: 70px; right: 20px;
      padding: 10px 15px;
      background: #333;
      color: #fff;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1001;
    }
    #toast.show { opacity: 1; }
    #toast.success { background: green; }
    #toast.error   { background: red; }

    /* Table */
    #tableControls {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #scanTable {
      width: 100%;
      border-collapse: collapse;
    }
    #scanTable th, #scanTable td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    #scanTable th {
      cursor: pointer;
      background: #eee;  /* se mantiene */
    }
    #pagination {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #pagination button:disabled {
      opacity: 0.5;
      cursor: default;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
   <!-- como scanner.html y LOGO.png est√°n en la misma carpeta public -->
   <img src="./LOGO.png" alt="Logo Empresa">
 </div>
    <h1>Scanner de rastreo</h1>
  </header>

  <div id="container">
    <aside>
      <nav>
        <a href="#"><span class="icon">üîç</span>Escaneo</a>
        <a href="#"><span class="icon">üìú</span>Historial</a>
        <a href="#"><span class="icon">‚ö†Ô∏è</span>Incidencias</a>
        <a href="#"><span class="icon">üìä</span>Reportes</a>
        <a href="#"><span class="icon">‚öôÔ∏è</span>Ajustes</a>
      </nav>
    </aside>

    <main>
      <!-- Scanner Widget -->
      <div id="scannerWidget">
        <p id="mode">Modo actual: <strong>Recibido</strong></p>
        <label for="modeSelect">Selecciona fase:</label>
        <select id="modeSelect">
          <optgroup label="Recepci√≥n">
            <option value="recibido">Recibido</option>
          </optgroup>
          <optgroup label="Tr√°nsito">
            <option value="en-transito-nacional-mx">En tr√°nsito nacional MX</option>
            <option value="en-transito-nacional-eu">En tr√°nsito nacional EU</option>
            <option value="en-transito-internacional">En tr√°nsito internacional</option>
          </optgroup>
          <optgroup label="Almac√©n">
            <option value="en-almacen-eu">En almac√©n EU</option>
            <option value="en-almacen-mx">En almac√©n MX</option>
          </optgroup>
        </select>

        <label for="barcodeInput">Escanea o pega el c√≥digo:</label>
        <input type="text" id="barcodeInput" placeholder="Escanea el c√≥digo aqu√≠" autofocus />

        <p id="status" aria-live="polite"></p>
      </div>

      <!-- Table Controls -->
      <div id="tableControls">
        <input type="text" id="searchInput" placeholder="Buscar paquete‚Ä¶" />
        <select id="stateFilter">
          <option value="">Todos los estados</option>
          <optgroup label="Recepci√≥n">
            <option value="Recibido">Recibido</option>
          </optgroup>
          <optgroup label="Tr√°nsito">
            <option value="En tr√°nsito nacional MX">En tr√°nsito nacional MX</option>
            <option value="En tr√°nsito nacional EU">En tr√°nsito nacional EU</option>
            <option value="En tr√°nsito internacional">En tr√°nsito internacional</option>
          </optgroup>
          <optgroup label="Almac√©n">
            <option value="En almac√©n EU">En almac√©n EU</option>
            <option value="En almac√©n MX">En almac√©n MX</option>
          </optgroup>
        </select>
      </div>

      <!-- √öltimos escaneos / Historial completo -->
      <table id="scanTable">
        <thead>
          <tr>
            <th data-col="time">Fecha y hora</th>
            <th data-col="id">Paquete</th>
            <th data-col="prev">Estado anterior</th>
            <th data-col="new">Estado nuevo</th>
            <th data-col="notes">Incidencias</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filas se inyectan desde la variable tableData -->
        </tbody>
      </table>

      <!-- Paginaci√≥n -->
      <div id="pagination">
        <button id="prevPage">Anterior</button>
        <span id="pageInfo">P√°gina 1</span>
        <button id="nextPage">Siguiente</button>
      </div>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <script>
    console.log("Script cargado correctamente");

    // --- Variables y carga inicial ---
    let mode = "recibido";
    let tableData = [];       // contendr√° TODO el historial de la BD
    let sortCol = 'time', sortAsc = false;
    let filterText = '', filterState = '';
    let currentPage = 1, pageSize = 10;

    // Carga TODO el historial de paquetes de la base de datos
    async function loadAllPackages() {
      try {
        const resp = await fetch("https://servidor-backend-paquetes.onrender.com/scanner/all");
        const paquetes = await resp.json();  // asume [{ paquete_id, estado_actual, historial:[{estado,fecha},...], ...}, ...]
        tableData = paquetes.map(p => {
          const h = p.historial;
          return {
            time: h[h.length-1].fecha,
            id: p.paquete_id,
            prev: h.length>1 ? h[h.length-2].estado : "",
            new: p.estado_actual,
            notes: ""
          };
        });
        renderTable();
      } catch (e) {
        console.error("No se pudo cargar historial:", e);
      }
    }

    // --- Scanner logic sin cambios ---
    document.getElementById("modeSelect").addEventListener("change", function() {
      mode = this.value;
      const text = this.options[this.selectedIndex].text;
      document.getElementById("mode").innerHTML = `Modo actual: <strong>${text}</strong>`;
      clearStatus();
    });

    function clearStatus() {
      const s = document.getElementById("status");
      s.innerText = "";
      s.className = "";
    }

    function sanitizeInput(v) {
      return v.replace(/[^0-9a-zA-Z]/g, "-");
    }

    const barcodeInput = document.getElementById("barcodeInput");
    ["beforeinput","input","paste","keyup"].forEach(evt => {
      barcodeInput.addEventListener(evt, () => {
        barcodeInput.value = sanitizeInput(barcodeInput.value);
      });
    });
    setInterval(() => {
      const v = sanitizeInput(barcodeInput.value);
      if (barcodeInput.value !== v) barcodeInput.value = v;
    }, 25);
    new MutationObserver(() => {
      const v = sanitizeInput(barcodeInput.value);
      if (barcodeInput.value !== v) barcodeInput.value = v;
    }).observe(barcodeInput, { childList:true,characterData:true,subtree:true });

    barcodeInput.addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        setTimeout(async () => {
          const code = sanitizeInput(this.value.trim());
          if (!code) return updateStatus("Por favor, escanea un c√≥digo v√°lido.", "error");
          const endpoint = mode==="recibido"
            ? "/scanner/recibido" 
            : `/scanner/${mode}`;
          try {
            const r = await fetch("https://servidor-backend-paquetes.onrender.com"+endpoint, {
              method: mode==="recibido"?"POST":"PUT",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ paquete_id: code })
            });
            if (r.ok) {
              updateStatus("Operaci√≥n correcta", "success");
              showToast(`Paquete ${code} actualizado`, "success");
              // recarga historial para reflejar cambios
              await loadAllPackages();
            } else {
              const err = (await r.json()).error;
              updateStatus(err, "error");
              showToast(err, "error");
            }
          } catch {
            updateStatus("Error de red.", "error");
            showToast("Error de red", "error");
          } finally {
            barcodeInput.value = "";
          }
        }, 150);
      }
    });

    function updateStatus(msg, cls) {
      const s = document.getElementById("status");
      s.innerText = msg;
      s.className = cls;
      setTimeout(clearStatus, 5000);
    }

    function showToast(msg, type) {
      const t = document.getElementById("toast");
      t.innerText = msg;
      t.className = `show ${type}`;
      setTimeout(() => t.className = "", 3000);
    }

    // --- Filtros y tabla ---
    document.getElementById("searchInput").addEventListener("input", e => {
      filterText = e.target.value.toLowerCase();
      currentPage = 1;
      renderTable();
    });
    document.getElementById("stateFilter").addEventListener("change", e => {
      filterState = e.target.value;
      currentPage = 1;
      renderTable();
    });
    document.querySelectorAll("#scanTable th").forEach(th => {
      th.addEventListener("click", () => {
        const col = th.dataset.col;
        sortAsc = (sortCol === col) ? !sortAsc : true;
        sortCol = col;
        renderTable();
      });
    });
    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage>1) { currentPage--; renderTable(); }
    });
    document.getElementById("nextPage").addEventListener("click", () => {
      const maxp = Math.ceil(filteredData().length/pageSize);
      if (currentPage<maxp) { currentPage++; renderTable(); }
    });

    function filteredData() {
      return tableData.filter(r => {
        return (!filterText  || r.id.toLowerCase().includes(filterText))
            && (!filterState || r.new === filterState);
      });
    }

    function renderTable() {
      let data = filteredData().sort((a,b) => {
        if (a[sortCol] < b[sortCol]) return sortAsc ? -1 : 1;
        if (a[sortCol] > b[sortCol]) return sortAsc ? 1 : -1;
        return 0;
      });
      const start = (currentPage-1)*pageSize;
      const page = data.slice(start, start+pageSize);

      const tbody = document.querySelector("#scanTable tbody");
      tbody.innerHTML = "";
      page.forEach(r => {
        const tr = document.createElement("tr");
        ['time','id','prev','new','notes'].forEach(key => {
          const td = document.createElement("td");
          td.innerText = r[key];
          tr.appendChild(td);
        });
        tr.addEventListener("click", () => {
          alert(`Detalle:\n${JSON.stringify(r,null,2)}`);
        });
        tbody.appendChild(tr);
      });
      document.getElementById("pageInfo").innerText =
        `P√°gina ${currentPage} de ${Math.max(1,Math.ceil(data.length/pageSize))}`;
      document.getElementById("prevPage").disabled = currentPage===1;
      document.getElementById("nextPage").disabled = currentPage>=Math.ceil(data.length/pageSize);
    }

    // Al iniciar, cargamos TODOS los paquetes
    loadAllPackages();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scanner de rastreo</title>
  <style>
    /* Layout */
    body {
      margin: 0; font-family: sans-serif;
      display: flex; flex-direction: column; height: 100vh;
    }
    header {
      position: fixed; top: 0; left: 0; right: 0;
      height: 60px; background: #333; color: #fff;
      display: flex; align-items: center; padding: 0 20px;
      z-index: 1000;
    }
    header .logo img {
      height: 40px; margin-right: 20px;
    }
    header h1 {
      margin: 0; font-size: 1.2rem;
    }
    #container {
      display: flex; flex: 1; padding-top: 60px;
    }
    aside {
      width: 20%; background: #f4f4f4;
      padding: 20px; box-sizing: border-box;
    }
    aside nav a {
      display: flex; align-items: center;
      padding: 8px 0; color: #333; text-decoration: none;
    }
    aside nav a .icon {
      margin-right: 8px;
    }
    main {
      flex: 1; padding: 20px;
      box-sizing: border-box; overflow-y: auto;
    }

    /* Scanner widget */
    #scannerWidget {
      background: #fafafa; padding: 15px;
      border: 1px solid #ddd; margin-bottom: 20px;
    }
    #scannerWidget label,
    #scannerWidget select,
    #scannerWidget input {
      display: block; width: 100%; margin-bottom: 10px;
    }
    #status {
      margin-top: 10px; font-size: 0.95rem;
    }
    .success { color: green; }
    .error   { color: red; }

    /* Mini‚Äëhistorial */
    #miniHistory {
      margin-bottom: 30px;
    }
    #miniHistory h2 {
      margin: 0 0 10px;
    }
    #miniTable {
      width: 100%; border-collapse: collapse;
    }
    #miniTable th, #miniTable td {
      border: 1px solid #ccc; padding: 6px; text-align: left;
    }
    #miniTable th {
      background: #eee;
    }
    .highlight {
      animation: highlight 1s ease;
    }
    @keyframes highlight {
      from { background: yellow; }
      to   { background: transparent; }
    }

    /* Toast */
    #toast {
      position: fixed; top: 70px; right: 20px;
      padding: 10px 15px; background: #333; color: #fff;
      border-radius: 4px; opacity: 0; transition: opacity 0.3s;
      z-index: 1001;
    }
    #toast.show { opacity: 1; }
    #toast.success { background: green; }
    #toast.error   { background: red; }

    /* Tables */
    #tableControls,
    #incTableControls {
      margin-bottom: 10px;
      display: flex; align-items: center; gap: 10px;
    }
    #counter {
      margin-bottom: 8px; font-weight: bold;
    }
    table {
      width: 100%; border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc; padding: 8px; text-align: left;
    }
    th {
      cursor: pointer; background: #eee;
    }
    #pagination, #incPagination {
      margin-top: 10px; display: flex;
      align-items: center; gap: 10px;
    }
    #pagination button:disabled,
    #incPagination button:disabled {
      opacity: 0.5; cursor: default;
    }

    /* Modal */
    .modal {
      display: none; position: fixed;
      top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5);
      align-items: center; justify-content: center;
      z-index: 1002;
    }
    .modal-content {
      background:#fff; padding:20px;
      border-radius:4px; width:400px; max-width:90%;
    }
    .modal-content h2 { margin-top:0; }
    .modal-content label {
      margin:10px 0 4px; display:block;
    }
    .modal-content input[type="text"],
    .modal-content select,
    .modal-content textarea {
      width:100%; box-sizing:border-box;
    }
    .modal-content textarea {
      resize:vertical; min-height:60px;
    }
    .modal-content .buttons {
      margin-top:15px; text-align:right; gap:10px;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="./LOGO.png" alt="Logo Empresa">
    </div>
    <h1>Scanner de rastreo</h1>
  </header>

  <div id="container">
    <aside>
      <nav>
        <a href="#" id="nav-escaneo"><span class="icon">üîç</span>Escaneo</a>
        <a href="#" id="nav-historial"><span class="icon">üìú</span>Historial</a>
        <a href="#" id="nav-incidencias"><span class="icon">‚ö†Ô∏è</span>Incidencias</a>
        <a href="#"><span class="icon">üìä</span>Reportes</a>
        <a href="#"><span class="icon">‚öôÔ∏è</span>Ajustes</a>
      </nav>
    </aside>

    <main>
      <!-- ESCANEO -->
      <section id="view-escaneo">
        <div id="scannerWidget">
          <p id="mode">Modo actual: <strong>Recibido</strong></p>
          <label for="modeSelect">Selecciona fase:</label>
          <select id="modeSelect">
            <optgroup label="Recepci√≥n">
              <option value="recibido">Recibido</option>
            </optgroup>
            <optgroup label="Tr√°nsito">
              <option value="en-transito-nacional-mx">En tr√°nsito nacional MX</option>
              <option value="en-transito-nacional-eu">En tr√°nsito nacional EU</option>
              <option value="en-transito-internacional">En tr√°nsito internacional</option>
            </optgroup>
            <optgroup label="Almac√©n">
              <option value="en-almacen-eu">En almac√©n EU</option>
              <option value="en-almacen-mx">En almac√©n MX</option>
            </optgroup>
          </select>
          <label for="barcodeInput">Escanea o pega el c√≥digo:</label>
          <input type="text" id="barcodeInput" placeholder="Escanea el c√≥digo aqu√≠" autofocus>
          <p id="status" aria-live="polite"></p>
        </div>

        <!-- MINI‚ÄëHISTORIAL -->
        <div id="miniHistory">
          <h2>√öltimos escaneos</h2>
          <table id="miniTable">
            <thead>
              <tr>
                <th data-col="time">Fecha y hora</th>
                <th data-col="id">Paquete</th>
                <th data-col="new">Estado nuevo</th>
                <th data-col="prev">Estado anterior</th>
                <th data-col="inc">Incidencias</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- HISTORIAL COMPLETO -->
      <section id="view-historial" style="display:none;">
        <div id="counter">Mostrando 0 de 0 paquetes</div>
        <div id="tableControls">
          <input type="text" id="searchInput" placeholder="Buscar paquete‚Ä¶">
          <select id="stateFilter">
            <option value="">Todos los estados</option>
            <optgroup label="Recepci√≥n"><option value="Recibido">Recibido</option></optgroup>
            <optgroup label="Tr√°nsito">
              <option value="En tr√°nsito nacional MX">En tr√°nsito nacional MX</option>
              <option value="En tr√°nsito nacional EU">En tr√°nsito nacional EU</option>
              <option value="En tr√°nsito internacional">En tr√°nsito internacional</option>
            </optgroup>
            <optgroup label="Almac√©n">
              <option value="En almac√©n EU">En almac√©n EU</option>
              <option value="En almac√©n MX">En almac√©n MX</option>
            </optgroup>
          </select>
        </div>
        <table id="scanTable">
          <thead>
            <tr>
              <th data-col="time">Fecha y hora</th>
              <th data-col="id">Paquete</th>
              <th data-col="new">Estado nuevo</th>
              <th data-col="prev">Estado anterior</th>
              <th data-col="inc">Incidencias</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="pagination">
          <button id="prevPage">Anterior</button>
          <span id="pageInfo">P√°gina 1</span>
          <button id="nextPage">Siguiente</button>
        </div>
      </section>

      <!-- INCIDENCIAS -->
      <section id="view-incidencias" style="display:none;">
        <div id="incTableControls">
          <input type="text" id="incSearch" placeholder="Buscar ID o paquete‚Ä¶">
          <select id="incTipoFilter">
            <option value="">Todos los tipos</option>
            <option value="Da√±ado">Da√±ado</option>
            <option value="Falta docs">Falta docs</option>
            <option value="Direcci√≥n incorrecta">Direcci√≥n incorrecta</option>
            <option value="Cliente ausente">Cliente ausente</option>
            <option value="Otro">Otro</option>
          </select>
          <select id="incEstadoFilter">
            <option value="">Todos los estados</option>
            <option value="Abierta">Abierta</option>
            <option value="En proceso">En proceso</option>
            <option value="Cerrada">Cerrada</option>
          </select>
        </div>
        <table id="incTable">
          <thead>
            <tr>
              <th data-col="_id">ID</th>
              <th data-col="paquete_id">Paquete</th>
              <th data-col="tipo">Tipo</th>
              <th data-col="estado">Estado</th>
              <th data-col="fecha_creacion">Fecha creaci√≥n</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="incPagination">
          <button id="incPrev">Anterior</button>
          <span id="incPageInfo">P√°gina 1</span>
          <button id="incNext">Siguiente</button>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal para reportar incidencia -->
  <div id="incidenceModal" class="modal">
    <div class="modal-content">
      <h2>Reportar incidencia</h2>
      <label for="incPaquete">Paquete</label>
      <input type="text" id="incPaquete" readonly>
      <label for="incTipo">Tipo de incidencia</label>
      <select id="incTipo">
        <option value="">-- Seleccione --</option>
        <option value="Da√±ado">Da√±ado</option>
        <option value="Falta docs">Falta docs</option>
        <option value="Direcci√≥n incorrecta">Direcci√≥n incorrecta</option>
        <option value="Cliente ausente">Cliente ausente</option>
        <option value="Otro">Otro</option>
      </select>
      <label for="incDesc">Descripci√≥n</label>
      <textarea id="incDesc"></textarea>
      <label for="incAdjuntos">Adjuntar fotos/documentos</label>
      <input type="file" id="incAdjuntos" multiple>
      <div class="buttons">
        <button id="incCancel">Cancelar</button>
        <button id="incSave">Guardar</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    console.log("Script cargado correctamente");

    // ‚Äî Estado global ‚Äî
    let mode="recibido";
    let tableData=[], totalItems=0, sortCol="time", sortAsc=false;
    let filterText="", filterState="";
    let currentPage=1, pageSize=10;

    let incData=[], incSortCol="fecha_creacion", incSortAsc=false;
    let incFilterText="", incFilterTipo="", incFilterEstado="";
    let incPage=1, incPageSize=10;

    // ‚Äî Elementos DOM ‚Äî
    const counterEl    = document.getElementById("counter");
    const scanTbody    = document.querySelector("#scanTable tbody");
    const miniTbody    = document.querySelector("#miniTable tbody");
    const pageInfo     = document.getElementById("pageInfo");
    const prevPageBtn  = document.getElementById("prevPage");
    const nextPageBtn  = document.getElementById("nextPage");
    const searchInput  = document.getElementById("searchInput");
    const stateFilter  = document.getElementById("stateFilter");
    const toast        = document.getElementById("toast");
    const modal        = document.getElementById("incidenceModal");
    const incPaquete   = document.getElementById("incPaquete");
    const incTipo      = document.getElementById("incTipo");
    const incDesc      = document.getElementById("incDesc");
    const incAdjuntos  = document.getElementById("incAdjuntos");
    const incCancel    = document.getElementById("incCancel");
    const incSave      = document.getElementById("incSave");
    const modeSelect   = document.getElementById("modeSelect");
    const barcodeInput = document.getElementById("barcodeInput");
    const statusEl     = document.getElementById("status");

    // ‚Äî Utilidades ‚Äî
    function clearStatus(){
      statusEl.innerText=""; statusEl.className="";
    }
    function updateStatus(msg,cls){
      statusEl.innerText=msg; statusEl.className=cls;
      setTimeout(clearStatus,5000);
    }
    function showToast(msg,type){
      toast.innerText=msg; toast.className=`show ${type}`;
      setTimeout(()=>toast.className="",3000);
    }
    function sanitizeInput(v){
      return v.replace(/[^0-9a-zA-Z]/g,"-");
    }
    function formatDateTime(iso){
      const d=new Date(iso);
      const pad=n=>n.toString().padStart(2,"0");
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} `
           + `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // ‚Äî Cambiar vista ‚Äî
    function showView(v){
      ["view-escaneo","view-historial","view-incidencias"]
        .forEach(id=>
          document.getElementById(id).style.display = id===v ? "block" : "none"
        );
    }
    document.getElementById("nav-escaneo").onclick   = ()=>showView("view-escaneo");
    document.getElementById("nav-historial").onclick = ()=>showView("view-historial");
    document.getElementById("nav-incidencias").onclick = ()=>{
      showView("view-incidencias");
      loadIncidencias();
    };

    // ‚Äî L√≥gica de escaneo / paquetes ‚Äî
    modeSelect.addEventListener("change",()=>{
      mode = modeSelect.value;
      document.getElementById("mode").innerHTML =
        `Modo actual: <strong>${modeSelect.selectedOptions[0].text}</strong>`;
      clearStatus();
    });
    ["beforeinput","input","paste","keyup"].forEach(evt=>{
      barcodeInput.addEventListener(evt,
        ()=>barcodeInput.value=sanitizeInput(barcodeInput.value)
      );
    });
    setInterval(()=>{
      const v=sanitizeInput(barcodeInput.value);
      if(barcodeInput.value!==v) barcodeInput.value=v;
    },25);
    new MutationObserver(()=>{
      const v=sanitizeInput(barcodeInput.value);
      if(barcodeInput.value!==v) barcodeInput.value=v;
    }).observe(barcodeInput,{childList:true,characterData:true,subtree:true});

    barcodeInput.addEventListener("keydown",e=>{
      if(e.key==="Enter"){
        e.preventDefault();
        setTimeout(async ()=>{
          const code=sanitizeInput(barcodeInput.value.trim());
          if(!code) return updateStatus("Por favor, escanea un c√≥digo v√°lido.","error");
          const endpoint = mode==="recibido"
            ? "/scanner/recibido"
            : `/scanner/${mode}`;
          try {
            const r = await fetch(
              `https://servidor-backend-paquetes.onrender.com${endpoint}`,
              {
                method: mode==="recibido"?"POST":"PUT",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ paquete_id:code })
              }
            );
            if(r.ok){
              updateStatus("Operaci√≥n correcta","success");
              showToast(`Paquete ${code} actualizado`,"success");
              await loadAllPackages();
            } else {
              const err=(await r.json()).error;
              updateStatus(err,"error");
              showToast(err,"error");
            }
          } catch {
            updateStatus("Error de red.","error");
            showToast("Error de red","error");
          } finally {
            barcodeInput.value="";
          }
        },150);
      }
    });

    // ‚Äî Carga historial completo ‚Äî
    async function loadAllPackages(){
      try {
        const r=await fetch("https://servidor-backend-paquetes.onrender.com/scanner/all");
        const arr=await r.json();
        tableData = arr.map(p=>{
          const h=p.historial;
          return {
            time: formatDateTime(h[h.length-1].fecha),
            id:   p.paquete_id,
            new:  p.estado_actual,
            prev: h.length>1? h[h.length-2].estado:"",
            inc:  p.incidencias_count
          };
        });
        totalItems = tableData.length;
        currentPage = 1;
        renderTable();
        renderMiniTable();
      } catch(e){
        console.error("No se pudo cargar historial:",e);
      }
    }

    // ‚Äî Mini‚Äëhistorial ‚Äî
    function renderMiniTable(){
      miniTbody.innerHTML="";
      tableData.slice(0,5).forEach(r=>{
        const tr=document.createElement("tr");
        ["time","id","new","prev"].forEach(k=>{
          const td=document.createElement("td");
          td.innerText=r[k];
          tr.appendChild(td);
        });
        const tdInc=document.createElement("td");
        tdInc.innerHTML = r.inc>0
          ? `<button class="inc-count" data-id="${r.id}">${r.inc}</button>`
          : "0";
        tr.appendChild(tdInc);
        const tdA=document.createElement("td");
        tdA.innerHTML=`
          <button class="${r.inc>0?"mini-view-inc":"mini-report-inc"}"
                  data-id="${r.id}">
            ${r.inc>0?"Ver":"Reportar"} incidencia
          </button>`;
        tr.appendChild(tdA);
        tr.addEventListener("click",()=>{
          tr.classList.add("highlight");
          setTimeout(()=>tr.classList.remove("highlight"),500);
        });
        miniTbody.appendChild(tr);
      });
    }

    // ‚Äî Historial completo ‚Äî
    function filteredData(){
      return tableData.filter(r=>
        (!filterText  || r.id.toLowerCase().includes(filterText)) &&
        (!filterState || r.new===filterState)
      );
    }
    function renderTable(){
      const data=filteredData().sort((a,b)=>{
        if(a[sortCol]<b[sortCol]) return sortAsc?-1:1;
        if(a[sortCol]>b[sortCol]) return sortAsc?1:-1;
        return 0;
      });
      const start=(currentPage-1)*pageSize+1;
      const end=Math.min(currentPage*pageSize, totalItems);
      counterEl.innerText = `Mostrando ${start}‚Äì${end} de ${totalItems} paquetes`;

      scanTbody.innerHTML="";
      data.slice(start-1,end).forEach(r=>{
        const tr=document.createElement("tr");
        ["time","id","new","prev"].forEach(k=>{
          const td=document.createElement("td");
          td.innerText=r[k];
          tr.appendChild(td);
        });
        const tdInc=document.createElement("td");
        tdInc.innerHTML= r.inc>0
          ? `<button class="hist-inc-count" data-id="${r.id}">${r.inc}</button>`
          : "0";
        tr.appendChild(tdInc);
        const tdA=document.createElement("td");
        tdA.innerHTML=`
          <button class="${r.inc>0?"hist-view-inc":"hist-report-inc"}"
                  data-id="${r.id}">
            ${r.inc>0?"Ver":"Reportar"} incidencia
          </button>`;
        tr.appendChild(tdA);
        scanTbody.appendChild(tr);
      });

      const totalPages=Math.ceil(totalItems/pageSize)||1;
      pageInfo.innerText=`P√°gina ${currentPage} de ${totalPages}`;
      prevPageBtn.disabled=currentPage===1;
      nextPageBtn.disabled=currentPage===totalPages;
    }

    // ‚Äî Controles de filtro y paginaci√≥n ‚Äî
    searchInput.addEventListener("input",e=>{
      filterText=e.target.value.toLowerCase();
      currentPage=1; renderTable();
    });
    stateFilter.addEventListener("change",e=>{
      filterState=e.target.value;
      currentPage=1; renderTable();
    });
    document.querySelectorAll("#scanTable th[data-col]").forEach(th=>{
      th.addEventListener("click",()=>{
        const c=th.dataset.col;
        sortAsc=(sortCol===c)?!sortAsc:true;
        sortCol=c;
        renderTable();
      });
    });
    prevPageBtn.addEventListener("click",()=>{
      if(currentPage>1){ currentPage--; renderTable(); }
    });
    nextPageBtn.addEventListener("click",()=>{
      const totalPages=Math.ceil(totalItems/pageSize);
      if(currentPage<totalPages){ currentPage++; renderTable(); }
    });

    // ‚Äî Redirecciones mini + completo a incidencias o modal ‚Äî
    document.querySelector("#miniTable").addEventListener("click",e=>{
      const id=e.target.dataset.id; if(!id) return;
      if(e.target.matches(".inc-count")||e.target.matches(".mini-view-inc")){
        showView("view-incidencias");
        document.getElementById("incSearch").value=id;
        incFilterText=id.toLowerCase();
        loadIncidencias();
      } else {
        incPaquete.value=id;
        modal.style.display="flex";
      }
    });
    document.querySelector("#scanTable").addEventListener("click",e=>{
      const id=e.target.dataset.id; if(!id) return;
      if(e.target.matches(".hist-inc-count")||e.target.matches(".hist-view-inc")){
        showView("view-incidencias");
        document.getElementById("incSearch").value=id;
        incFilterText=id.toLowerCase();
        loadIncidencias();
      } else {
        incPaquete.value=id;
        modal.style.display="flex";
      }
    });

    // ‚Äî Modal: reportar incidencia ‚Äî
    incCancel.addEventListener("click",()=>modal.style.display="none");
    incSave.addEventListener("click",async ()=>{
      const form=new FormData();
      form.append("paquete_id",incPaquete.value);
      form.append("tipo",incTipo.value);
      form.append("descripcion",incDesc.value);
      Array.from(incAdjuntos.files).forEach(f=>form.append("adjuntos",f));
      try {
        const r=await fetch(
          "https://servidor-backend-paquetes.onrender.com/scanner/incidencias",
          { method:"POST", body: form }
        );
        const j=await r.json();
        if(r.ok){
          showToast("Incidencia creada correctamente","success");
          modal.style.display="none";
          await loadAllPackages();
        } else {
          showToast(j.error||"Error al crear incidencia","error");
        }
      } catch {
        showToast("Error de red","error");
      }
    });

    // ‚Äî Incidencias: lista, filtros, paginaci√≥n, ver/editar ‚Äî
    const incTbody      = document.querySelector("#incTable tbody");
    const incPrevBtn    = document.getElementById("incPrev");
    const incNextBtn    = document.getElementById("incNext");
    const incPageInfoEl = document.getElementById("incPageInfo");

    document.getElementById("incSearch").addEventListener("input",e=>{
      incFilterText=e.target.value.toLowerCase();
      incPage=1; renderIncTable();
    });
    document.getElementById("incTipoFilter").addEventListener("change",e=>{
      incFilterTipo=e.target.value;
      incPage=1; renderIncTable();
    });
    document.getElementById("incEstadoFilter").addEventListener("change",e=>{
      incFilterEstado=e.target.value;
      incPage=1; renderIncTable();
    });

    async function loadIncidencias(){
      try {
        const r=await fetch("https://servidor-backend-paquetes.onrender.com/scanner/incidencias");
        incData=await r.json();
        incPage=1; renderIncTable();
      } catch(e){
        console.error("Error cargando incidencias:",e);
      }
    }

    function filteredInc(){
      return incData.filter(i=>
        (!incFilterText || i._id.includes(incFilterText) || i.paquete_id.toLowerCase().includes(incFilterText)) &&
        (!incFilterTipo  || i.tipo===incFilterTipo) &&
        (!incFilterEstado|| i.estado===incFilterEstado)
      );
    }

    function renderIncTable(){
      const all=filteredInc().sort((a,b)=>{
        if(a[incSortCol]<b[incSortCol]) return incSortAsc?-1:1;
        if(a[incSortCol]>b[incSortCol]) return incSortAsc?1:-1;
        return 0;
      });
      const start=(incPage-1)*incPageSize+1;
      const end=Math.min(incPage*incPageSize, all.length);
      incPageInfoEl.innerText = `Mostrando ${start}‚Äì${end} de ${all.length} incidencias`;

      incTbody.innerHTML="";
      all.slice(start-1,end).forEach(i=>{
        const tr=document.createElement("tr");
        ["_id","paquete_id","tipo"].forEach(k=>{
          const td=document.createElement("td");
          td.innerText=i[k];
          tr.appendChild(td);
        });
        const tdEst=document.createElement("td");
        tdEst.innerHTML=`<span style="color:${
          i.estado==="Abierta"?"red":
          i.estado==="En proceso"?"orange":"green"
        }">${i.estado}</span>`;
        tr.appendChild(tdEst);

        const tdDate=document.createElement("td");
        tdDate.innerText=formatDateTime(i.fecha_creacion);
        tr.appendChild(tdDate);

        const tdA=document.createElement("td");
        tdA.innerHTML=`
          <button class="view-inc" data-id="${i._id}">Ver</button>
          <button class="edit-inc" data-id="${i._id}">Editar Estado</button>
        `;
        tr.appendChild(tdA);
        incTbody.appendChild(tr);
      });

      const maxP=Math.ceil(all.length/incPageSize)||1;
      incPrevBtn.disabled=incPage===1;
      incNextBtn.disabled=incPage===maxP;
    }

    document.querySelectorAll("#incTable th[data-col]").forEach(th=>{
      th.addEventListener("click",()=>{
        const c=th.dataset.col;
        incSortAsc=(incSortCol===c)?!incSortAsc:true;
        incSortCol=c;
        renderIncTable();
      });
    });
    incPrevBtn.addEventListener("click",()=>{
      if(incPage>1){ incPage--; renderIncTable(); }
    });
    incNextBtn.addEventListener("click",()=>{
      const maxP=Math.ceil(filteredInc().length/incPageSize);
      if(incPage<maxP){ incPage++; renderIncTable(); }
    });

    document.getElementById("view-incidencias").addEventListener("click",e=>{
      if(e.target.matches(".view-inc")){
        alert("Ver detalle de incidencia "+e.target.dataset.id);
      }
      if(e.target.matches(".edit-inc")){
        alert("Editar estado de incidencia "+e.target.dataset.id);
      }
    });

    // ‚Äî Arranque ‚Äî
    loadAllPackages();
    showView("view-escaneo");
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scanner de rastreo</title>
  <style>
    /* Layout */
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 60px;
      background: #333;
      color: #fff;
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
    }
    header .logo img {
      height: 40px;
      margin-right: 20px;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }
    #container {
      display: flex;
      flex: 1;
      padding-top: 60px; /* espacio para header */
    }
    aside {
      width: 20%;
      background: #014235;   /* sidebar en #014235 */
      padding: 20px;
      box-sizing: border-box;
    }
    aside nav a {
      display: flex;
      align-items: center;
      padding: 8px 0;
      color: #fff;
      text-decoration: none;
    }
    aside nav a .icon {
      margin-right: 8px;
    }
    main {
      flex: 1;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    /* Scanner widget */
    #scannerWidget {
      background: #014235;   /* widget en #014235 */
      padding: 15px;
      border: 1px solid #ddd;
      margin-bottom: 30px;
    }
    #scannerWidget label, 
    #scannerWidget select,
    #scannerWidget input {
      display: block;
      width: 100%;
      margin-bottom: 10px;
    }
    #status {
      margin-top: 10px;
      font-size: 0.95rem;
    }
    .success {
      color: green;
    }
    .error {
      color: red;
    }

    /* Toast */
    #toast {
      position: fixed;
      top: 70px; right: 20px;
      padding: 10px 15px;
      background: #333;
      color: #fff;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1001;
    }
    #toast.show {
      opacity: 1;
    }
    #toast.success { background: green; }
    #toast.error   { background: red; }

    /* Table */
    #tableControls {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #scanTable {
      width: 100%;
      border-collapse: collapse;
    }
    #scanTable th, #scanTable td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    #scanTable th {
      cursor: pointer;
      background: #eee; /* no tocar */
    }
    #pagination {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #pagination button:disabled {
      opacity: 0.5;
      cursor: default;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="ruta/a/mi-logo.png" alt="Logo de la empresa">
    </div>
    <h1>Scanner de rastreo</h1>
  </header>

  <div id="container">
    <aside>
      <nav>
        <a href="#"><span class="icon">üîç</span>Escaneo</a>
        <a href="#"><span class="icon">üìú</span>Historial</a>
        <a href="#"><span class="icon">‚ö†Ô∏è</span>Incidencias</a>
        <a href="#"><span class="icon">üìä</span>Reportes</a>
        <a href="#"><span class="icon">‚öôÔ∏è</span>Ajustes</a>
      </nav>
    </aside>

    <main>
      <!-- Scanner Widget -->
      <div id="scannerWidget">
        <p id="mode">Modo actual: <strong>Recibido</strong></p>
        <label for="modeSelect">Selecciona fase:</label>
        <select id="modeSelect">
          <optgroup label="Recepci√≥n">
            <option value="recibido">Recibido</option>
          </optgroup>
          <optgroup label="Tr√°nsito">
            <option value="en-transito-nacional-mx">En tr√°nsito nacional MX</option>
            <option value="en-transito-nacional-eu">En tr√°nsito nacional EU</option>
            <option value="en-transito-internacional">En tr√°nsito internacional</option>
          </optgroup>
          <optgroup label="Almac√©n">
            <option value="en-almacen-eu">En almac√©n EU</option>
            <option value="en-almacen-mx">En almac√©n MX</option>
          </optgroup>
        </select>

        <label for="barcodeInput">Escanea o pega el c√≥digo:</label>
        <input type="text" id="barcodeInput" placeholder="Escanea el c√≥digo aqu√≠" autofocus />

        <p id="status" aria-live="polite"></p>
      </div>

      <!-- Table Controls -->
      <div id="tableControls">
        <input type="text" id="searchInput" placeholder="Buscar paquete‚Ä¶" />
        <select id="stateFilter">
          <option value="">Todos los estados</option>
          <optgroup label="Recepci√≥n">
            <option value="Recibido">Recibido</option>
          </optgroup>
          <optgroup label="Tr√°nsito">
            <option value="En tr√°nsito nacional MX">En tr√°nsito nacional MX</option>
            <option value="En tr√°nsito nacional EU">En tr√°nsito nacional EU</option>
            <option value="En tr√°nsito internacional">En tr√°nsito internacional</option>
          </optgroup>
          <optgroup label="Almac√©n">
            <option value="En almac√©n EU">En almac√©n EU</option>
            <option value="En almac√©n MX">En almac√©n MX</option>
          </optgroup>
        </select>
      </div>

      <!-- √öltimos escaneos -->
      <table id="scanTable">
        <thead>
          <tr>
            <th data-col="time">Fecha y hora</th>
            <th data-col="id">Paquete</th>
            <th data-col="prev">Estado anterior</th>
            <th data-col="new">Estado nuevo</th>
            <th data-col="notes">Incidencias</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filas generadas din√°micamente -->
        </tbody>
      </table>

      <!-- Paginaci√≥n -->
      <div id="pagination">
        <button id="prevPage">Anterior</button>
        <span id="pageInfo">P√°gina 1</span>
        <button id="nextPage">Siguiente</button>
      </div>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <script>
    console.log("Script cargado correctamente");

    // Scanner logic
    let mode = "recibido";
    const modeSelect = document.getElementById("modeSelect");
    modeSelect.addEventListener("change", () => {
      mode = modeSelect.value;
      const text = modeSelect.options[modeSelect.selectedIndex].text;
      document.getElementById("mode").innerHTML = `Modo actual: <strong>${text}</strong>`;
      clearStatus();
    });

    function clearStatus() {
      const status = document.getElementById("status");
      status.innerText = "";
      status.className = "";
    }

    function sanitizeInput(value) {
      return value.replace(/[^0-9a-zA-Z]/g, "-");
    }

    const barcodeInput = document.getElementById("barcodeInput");
    ["beforeinput","input","paste","keyup"].forEach(evt => {
      barcodeInput.addEventListener(evt, () => {
        barcodeInput.value = sanitizeInput(barcodeInput.value);
      });
    });
    setInterval(() => {
      const v = sanitizeInput(barcodeInput.value);
      if (barcodeInput.value !== v) barcodeInput.value = v;
    }, 25);
    new MutationObserver(() => {
      const v = sanitizeInput(barcodeInput.value);
      if (barcodeInput.value !== v) barcodeInput.value = v;
    }).observe(barcodeInput, { childList:true,characterData:true,subtree:true });

    async function sendBarcode(barcode) {
      if (!barcode) {
        updateStatus("Por favor, escanea un c√≥digo v√°lido.", "error");
        return;
      }
      const prevLabel = document.querySelector("#mode").textContent.split(":")[1].trim();
      const endpoint = mode === "recibido"
        ? "/scanner/recibido"
        : `/scanner/${mode}`;
      try {
        const resp = await fetch(`https://servidor-backend-paquetes.onrender.com${endpoint}`, {
          method: mode==="recibido"?"POST":"PUT",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ paquete_id: barcode })
        });
        if (resp.ok) {
          updateStatus("Operaci√≥n realizada correctamente.", "success");
          const newLabel = modeSelect.options[modeSelect.selectedIndex].text;
          addScanRecord(barcode, prevLabel, newLabel);
          showToast(`Paquete ${barcode} actualizado`, "success");
        } else {
          const err = (await resp.json()).error;
          updateStatus(err, "error");
          showToast(err, "error");
        }
      } catch {
        updateStatus("Error al conectar con el servidor.", "error");
        showToast("Error de red", "error");
      } finally {
        barcodeInput.value = "";
        barcodeInput.focus();
      }
    }

    function updateStatus(msg, cls) {
      const s = document.getElementById("status");
      s.innerText = msg;
      s.className = cls;
      setTimeout(clearStatus, 5000);
    }

    // Toast
    function showToast(msg, type) {
      const t = document.getElementById("toast");
      t.innerText = msg;
      t.className = `show ${type}`;
      setTimeout(() => t.className = "", 3000);
    }

    // Tabla de √∫ltimos escaneos
    const lastScans = [];
    let sortCol = 'time', sortAsc = false;
    let filterText = '', filterState = '';
    let currentPage = 1, pageSize = 10;

    function addScanRecord(id, prevState, newState) {
      const now = new Date().toLocaleString();
      lastScans.unshift({ time: now, id, prevState, newState, notes: '' });
      if (lastScans.length > 100) lastScans.pop();
      renderTable();
    }

    document.getElementById("searchInput").addEventListener("input", e => {
      filterText = e.target.value.toLowerCase();
      currentPage = 1;
      renderTable();
    });
    document.getElementById("stateFilter").addEventListener("change", e => {
      filterState = e.target.value;
      currentPage = 1;
      renderTable();
    });

    document.querySelectorAll("#scanTable th").forEach(th => {
      th.addEventListener("click", () => {
        const col = th.dataset.col;
        if (sortCol === col) sortAsc = !sortAsc;
        else { sortCol = col; sortAsc = true; }
        renderTable();
      });
    });

    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage > 1) { currentPage--; renderTable(); }
    });
    document.getElementById("nextPage").addEventListener("click", () => {
      const max = Math.ceil(filteredData().length / pageSize);
      if (currentPage < max) { currentPage++; renderTable(); }
    });

    function filteredData() {
      return lastScans.filter(r =>
        (!filterText  || r.id.toLowerCase().includes(filterText)) &&
        (!filterState || r.newState === filterState)
      );
    }

    function renderTable() {
      const data = filteredData().sort((a,b) => {
        if (a[sortCol] < b[sortCol]) return sortAsc ? -1 : 1;
        if (a[sortCol] > b[sortCol]) return sortAsc ? 1 : -1;
        return 0;
      });
      const start = (currentPage - 1) * pageSize;
      const pageData = data.slice(start, start + pageSize);

      const tbody = document.querySelector("#scanTable tbody");
      tbody.innerHTML = "";
      pageData.forEach(r => {
        const tr = document.createElement("tr");
        ['time','id','prevState','newState','notes'].forEach(key => {
          const td = document.createElement("td");
          td.innerText = r[key];
          tr.appendChild(td);
        });
        tr.addEventListener("click", () => {
          alert(`Detalle:\n${JSON.stringify(r,null,2)}`);
        });
        tbody.appendChild(tr);
      });

      document.getElementById("pageInfo").innerText =
        `P√°gina ${currentPage} de ${Math.max(1,Math.ceil(data.length/pageSize))}`;
      document.getElementById("prevPage").disabled = currentPage === 1;
      document.getElementById("nextPage").disabled = currentPage >= Math.ceil(data.length/pageSize);
    }

    // Inicializa tabla
    renderTable();
  </script>
</body>
</html>
